(()=>{"use strict";var e,t,o;!function(e){e.CONDITIONS={new:{value:"nwt",label:"NWT (New With Tags)"},like_new:{value:"nwot",label:"NWOT (New Without Tags)"},good:{value:"good",label:"Good - Used"},fair:{value:"fair",label:"Fair - Used"},poor:{value:"poor",label:"Poor - Used"}}}(e||(e={})),function(e){e.CONDITIONS={new:{value:"new",label:"New"},like_new:{value:"like_new",label:"Like New"},good:{value:"good",label:"Good"},fair:{value:"fair",label:"Fair"},poor:{value:"poor",label:"Poor"}}}(t||(t={})),function(e){e.CONDITIONS={new:{value:"brand_new",label:"Brand new"},like_new:{value:"like_new",label:"Like new"},good:{value:"used_excellent",label:"Used - Excellent"},fair:{value:"used_good",label:"Used - Good"},poor:{value:"used_fair",label:"Used - Fair"}},e.PARCEL_SIZES={extra_extra_small:{maxOz:4,label:"Extra extra small",price:4.99},extra_small:{maxOz:8,label:"Extra small",price:5.99},small:{maxOz:12,label:"Small",price:6.49},medium:{maxLb:1,label:"Medium",price:7.99},large:{maxLb:2,label:"Large",price:11.99},extra_large:{maxLb:10,label:"Extra large",price:13.99}}}(o||(o={})),Error;const i=(...e)=>{},n=(...e)=>{console.info("[Compr Extension]",...e)},a=(...e)=>{console.warn("[Compr Extension]",...e)},l=(...e)=>{console.error("[Compr Extension]",...e)};function r(){return document.hidden}function s(e,t,o=!1){if(r()){const e=o?10:0;return 0===e?Promise.resolve():new Promise(t=>setTimeout(t,e))}{const o=Math.floor(Math.random()*(t-e+1))+e;return new Promise(e=>setTimeout(e,o))}}function c(e){return new Promise(t=>setTimeout(t,e))}const u=new class{delay(e,t){return s(e,t)}async typeText(e,t){if(e.focus(),e.value="",r())e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),await s(10,20,!0);else{for(const o of t)e.value+=o,e.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(50,150);e.dispatchEvent(new Event("change",{bubbles:!0}))}e.blur()}async clickElement(e){await this.delay(500,2e3),e.scrollIntoView({behavior:r()?"auto":"smooth",block:"center"}),await this.delay(200,500),e.click()}async waitForElement(e,t=1e4){return document.querySelector(e)||new Promise((o,i)=>{const n=setTimeout(()=>{a.disconnect(),i(new Error(`Element not found: ${e}`))},t),a=new MutationObserver(()=>{const t=document.querySelector(e);t&&(clearTimeout(n),a.disconnect(),o(t))});a.observe(document.body,{childList:!0,subtree:!0})})}async checkLoginStatus(){try{if(window.location.href.includes("/login")||window.location.href.includes("/signup"))return l("Redirected to login page - user is not logged in"),!1;const e=document.querySelector('a[href*="/login"]'),t=document.querySelector('a[href*="/signup"]');return e||t?(l("Login/signup buttons found - user is not logged in"),!1):document.querySelector('[data-testid="navigation__profile"]')||document.querySelector('[data-testid="user-menu"]')||document.querySelector('button[aria-label*="account" i]')||document.querySelector('button[aria-label*="profile" i]')?(n("User menu found - user is logged in"),!0):window.location.pathname.includes("/products/create")?(n("On /products/create page without login prompts - assuming logged in"),!0):(a("Could not definitively determine login status - proceeding cautiously"),!0)}catch(e){return l("Error checking login status:",e),!0}}async downloadImage(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to download image: ${t.statusText}`);return await t.blob()}async uploadImages(e){if(!e||0===e.length)return void a("No photo URLs provided, skipping image upload");n(`Uploading ${e.length} images to Depop`,e);const t=e.slice(0,4);let o=0;for(let e=0;e<t.length;e++){i((t.length,t[e]));try{const i=await this.waitForElement('input[data-testid="upload-input__input"]');n("Found file input:",i),n(`Downloading image from: ${t[e]}`);const a=await this.downloadImage(t[e]);n(`Downloaded blob: size=${a.size}, type=${a.type}`);const l=`image-${e+1}.jpg`,r=new File([a],l,{type:a.type||"image/jpeg"});n(`Created file: name=${r.name}, size=${r.size}, type=${r.type}`);const s=new DataTransfer;s.items.add(r),n(`DataTransfer files: ${s.files.length}`),i.files=s.files;const u=["input","change"];for(const e of u)i.dispatchEvent(new Event(e,{bubbles:!0}));n(`Triggered events for image ${e+1}, waiting for upload...`),await c(2500),o++,n(`Successfully uploaded image ${e+1}/${t.length}`)}catch(t){l(`Failed to upload image ${e+1}:`,t)}}if(0===o)throw new Error("Failed to upload any images");n(`${o}/${t.length} images uploaded successfully`)}async fillTitle(e){}async fillDescription(e){const t=e.length>1e3?e.substring(0,1e3):e,o=await this.waitForElement('textarea#description[name="description"]');await this.typeText(o,t)}async selectCategory(e,t){try{const o=await this.waitForElement('input#group-input[role="combobox"]');if(await this.clickElement(o),await this.delay(1e3,1500),e){const t=document.querySelectorAll('ul#group-menu li[role="option"]');n(`Found ${t.length} category options`);for(const o of Array.from(t)){const t=o.textContent?.trim()||"";if(t.toLowerCase().includes(e.toLowerCase())){n(`Selecting category: ${t}`),await this.clickElement(o),await this.delay(1e3,1500);break}}}else{const e=document.querySelector('ul#group-menu li[role="option"]');e&&(await this.clickElement(e),await this.delay(1e3,1500))}if(t){await this.delay(1e3,1500);const e=await this.waitForElement('input#productType-input[role="combobox"]',5e3);await this.clickElement(e),await this.delay(1e3,1500);const o=document.querySelectorAll('ul#productType-menu li[role="option"]');n(`Found ${o.length} subcategory options`);for(const e of Array.from(o)){const o=e.textContent?.trim()||"";if(o.toLowerCase().includes(t.toLowerCase())){n(`Selecting subcategory: ${o}`),await this.clickElement(e),await this.delay(500,1e3);break}}}}catch(e){throw a("Failed to select category:",e),e}}async fillBrand(e){try{const t=await this.waitForElement('input#brand-input[role="combobox"]');if(e){await this.typeText(t,e),await this.delay(500,1e3);const o=document.querySelectorAll('ul#brand-menu li[role="option"]');o.length>0&&(n("Selecting first brand option"),await this.clickElement(o[0]))}else{await this.typeText(t,"No brand"),await this.delay(500,1e3);const e=document.querySelectorAll('ul#brand-menu li[role="option"]');e.length>0&&await this.clickElement(e[0])}}catch(e){throw a("Failed to fill brand:",e),e}}async selectSize(e){if(e)try{const t=await this.waitForElement('input#variants-input[role="combobox"]',5e3);await this.clickElement(t),await this.delay(500,1e3);const o=document.querySelectorAll('ul#variants-menu li[role="option"]');n(`Found ${o.length} size options`);for(const t of Array.from(o)){const o=t.textContent?.toLowerCase()||"";if(o.includes(e.toLowerCase()))return n(`Selecting size: ${o}`),void await this.clickElement(t)}o.length>0&&(a(`Size "${e}" not found, selecting first option`),await this.clickElement(o[0]))}catch(e){n("Size field not found or failed to select - skipping (optional)")}}async selectColor(e){if(e)try{const t=await this.waitForElement('input#colour-input[role="combobox"]',5e3);await this.clickElement(t),await this.delay(500,1e3);const o=document.querySelectorAll('ul#colour-menu li[role="option"]');n(`Found ${o.length} color options`);for(const t of Array.from(o)){const o=t.textContent?.toLowerCase()||"";if(o.includes(e.toLowerCase()))return n(`Selecting color: ${o}`),void await this.clickElement(t)}a(`Color "${e}" not found in options`)}catch(e){n("Color field not found or failed to select - skipping (optional)")}}async selectCondition(e){const t=o.CONDITIONS[e]||o.CONDITIONS.good;try{const e=await this.waitForElement('input#condition-input[role="combobox"]');await this.clickElement(e),await this.delay(500,1e3);const o=document.querySelectorAll('ul#condition-menu li[role="option"]');n(`Found ${o.length} condition options`);for(const e of Array.from(o)){const o=e.textContent?.trim()||"";if(o.toLowerCase()===t.label.toLowerCase())return n(`Selecting condition: ${o}`),void await this.clickElement(e)}for(const e of Array.from(o)){const o=e.textContent?.toLowerCase()||"";if(o.includes(t.label.toLowerCase()))return n(`Selecting condition (partial match): ${o}`),void await this.clickElement(e)}for(const e of Array.from(o))if((e.textContent?.toLowerCase()||"").includes("good"))return a("Using default condition: Good"),void await this.clickElement(e)}catch(e){throw a("Failed to select condition:",e),e}}async fillPrice(e){try{const t=await this.waitForElement('input[data-testid="priceAmount__input"]');t.focus(),await this.delay(100,200),t.select(),t.value=e.toFixed(2),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(300,500),t.blur(),n("Price set to:",t.value)}catch(e){throw a("Failed to fill price:",e),e}}async selectShipping(e,t){try{const o=16*(e||0)+(t||0),i=o/16;let l="Medium";l=o<4?"Extra extra small":o<8?"Extra small":o<12?"Small":i<1?"Medium":i<2?"Large":"Extra large",n(`Selecting parcel size: ${l} (${i.toFixed(2)} lb)`);const r=await this.waitForElement('input#shippingMethods-input[role="combobox"]');await this.clickElement(r),await this.delay(500,1e3);const s=document.querySelectorAll('ul#shippingMethods-menu li[role="option"]');n(`Found ${s.length} shipping options`);for(const e of Array.from(s))if((e.textContent?.toLowerCase()||"").includes(l.toLowerCase()))return n(`Selecting shipping option: ${l}`),void await this.clickElement(e);for(const e of Array.from(s))if((e.textContent?.toLowerCase()||"").includes("medium"))return a("Using default parcel size: Medium"),void await this.clickElement(e)}catch(e){throw a("Failed to select shipping:",e),e}}async submitListing(){try{const e=await this.waitForElement('button[type="submit"]',1e4);n("Found Post button, clicking..."),await this.clickElement(e),await c(4e3);const t=window.location.href;n("Current URL after submission:",t);const o=t.match(/\/products\/([a-zA-Z0-9_-]+)/),i=o?o[1]:"success";return n("Listing submitted successfully:",{platformListingId:i,platformUrl:t}),{platformListingId:i,platformUrl:t}}catch(e){throw l("Failed to submit listing:",e),e}}async createListing(e){try{if(n("Starting Depop listing creation for:",e.title),n("Listing data received:",JSON.stringify(e)),n("Photo URLs:",e.photo_urls),n("Checking Depop login status..."),!await this.checkLoginStatus())throw new Error("Not logged in to Depop. Please log in at depop.com and try again.");n("Login check passed - proceeding with listing creation"),await this.uploadImages(e.photo_urls),await this.fillTitle(e.title),await this.fillDescription(e.description),await this.selectCategory(e.depop_category||e.category,e.depop_subcategory||null),await this.fillBrand(e.brand),await this.selectSize(e.size),await this.selectColor(e.color),await this.selectCondition(e.condition),await this.fillPrice(e.price),await this.selectShipping(e.weight_lb,e.weight_oz),n("Waiting for form to be ready for submission..."),await this.delay(2e3,3e3);const t=await this.submitListing();return{success:!0,listingId:e.id,platform:"depop",platformListingId:t.platformListingId,platformUrl:t.platformUrl}}catch(t){return l("Failed to create Depop listing:",t),{success:!1,listingId:e.id,platform:"depop",error:t instanceof Error?t.message:"Unknown error"}}}};chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.type,"CREATE_LISTING"===e.type){const{listingData:t}=e.payload;return u.createListing(t).then(e=>{o(e)}).catch(e=>{o({success:!1,listingId:t.id,platform:"depop",error:e.message})}),!0}if("CHECK_LOGIN"===e.type){const e=function(){console.log("[Depop] Checking login status...");const e=document.querySelector('a[href*="/login"]'),t=document.querySelector('a[href*="/signup"]'),o=Array.from(document.querySelectorAll("button, a")),i=o.some(e=>{const t=e.textContent?.toLowerCase()||"";return t.includes("log in")||t.includes("login")||t.includes("sign in")}),n=o.some(e=>{const t=e.textContent?.toLowerCase()||"";return t.includes("sign up")||t.includes("signup")||t.includes("register")}),a=document.querySelector('form[action*="login"], input[name="username"], input[name="email"][type="email"]'),l=document.querySelector('input[type="password"]');if(e||t||i||n||a&&l)return console.log("[Depop] Found login indicators - NOT logged in"),!1;const r=window.location.pathname.toLowerCase();if(r.includes("/login")||r.includes("/signup")||r.includes("/register"))return console.log("[Depop] On login page - NOT logged in"),!1;if(document.querySelector('[data-testid="user-menu"], [class*="UserMenu"], [aria-label*="user menu"]'))return console.log("[Depop] Found user menu - logged in"),!0;const s=document.querySelector('nav a[href^="/u/"], header a[href^="/u/"]');return s&&s.textContent&&s.textContent.trim().length>0?(console.log("[Depop] Found profile link in nav - logged in"),!0):document.querySelector('a[href*="/messages"]')?(console.log("[Depop] Found messages link - logged in"),!0):document.querySelector('a[href*="/settings"], a[href*="/account"]')?(console.log("[Depop] Found account/settings link - logged in"),!0):(console.log("[Depop] No clear indicators - NOT logged in"),!1)}();return n("Depop login status:",e),o({loggedIn:e}),!0}}),n("Depop content script loaded")})();