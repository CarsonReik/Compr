(()=>{"use strict";var e,t,i;!function(e){e.CONDITIONS={new:{value:"nwt",label:"NWT (New With Tags)"},like_new:{value:"nwot",label:"NWOT (New Without Tags)"},good:{value:"good",label:"Good - Used"},fair:{value:"fair",label:"Fair - Used"},poor:{value:"poor",label:"Poor - Used"}}}(e||(e={})),function(e){e.CONDITIONS={new:{value:"new",label:"New"},like_new:{value:"like_new",label:"Like New"},good:{value:"good",label:"Good"},fair:{value:"fair",label:"Fair"},poor:{value:"poor",label:"Poor"}}}(t||(t={})),function(e){e.CONDITIONS={new:{value:"brand_new",label:"Brand new"},like_new:{value:"like_new",label:"Like new"},good:{value:"used_excellent",label:"Used - Excellent"},fair:{value:"used_good",label:"Used - Good"},poor:{value:"used_fair",label:"Used - Fair"}},e.PARCEL_SIZES={extra_extra_small:{maxOz:4,label:"Extra extra small",price:4.99},extra_small:{maxOz:8,label:"Extra small",price:5.99},small:{maxOz:12,label:"Small",price:6.49},medium:{maxLb:1,label:"Medium",price:7.99},large:{maxLb:2,label:"Large",price:11.99},extra_large:{maxLb:10,label:"Extra large",price:13.99}}}(i||(i={})),Error;const o=(...e)=>{},a=(...e)=>{console.info("[Compr Extension]",...e)},n=(...e)=>{console.warn("[Compr Extension]",...e)},l=(...e)=>{console.error("[Compr Extension]",...e)},s=new class{delay(e,t){const i=Math.floor(Math.random()*(t-e+1))+e;return new Promise(e=>setTimeout(e,i))}async typeText(e,t){e.focus(),e.value="";for(const i of t)e.value+=i,e.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(50,150);e.dispatchEvent(new Event("change",{bubbles:!0})),e.blur()}async clickElement(e){await this.delay(500,2e3),e.scrollIntoView({behavior:"smooth",block:"center"}),await this.delay(200,500),e.click()}async waitForElement(e,t=1e4){const i=Date.now();for(;Date.now()-i<t;){const t=document.querySelector(e);if(t)return t;await this.delay(100,300)}throw new Error(`Element not found: ${e}`)}async downloadImage(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to download image: ${t.statusText}`);return await t.blob()}async uploadImages(e){if(!e||0===e.length)return void n("No photo URLs provided, skipping image upload");a(`Uploading ${e.length} images to Depop`,e);const t=e.slice(0,4);let i=0;for(let e=0;e<t.length;e++){o((t.length,t[e]));try{const o=await this.waitForElement('input[data-testid="upload-input__input"]');a("Found file input:",o),a(`Downloading image from: ${t[e]}`);const n=await this.downloadImage(t[e]);a(`Downloaded blob: size=${n.size}, type=${n.type}`);const l=`image-${e+1}.jpg`,s=new File([n],l,{type:n.type||"image/jpeg"});a(`Created file: name=${s.name}, size=${s.size}, type=${s.type}`);const r=new DataTransfer;r.items.add(s),a(`DataTransfer files: ${r.files.length}`),o.files=r.files;const c=["input","change"];for(const e of c)o.dispatchEvent(new Event(e,{bubbles:!0}));a(`Triggered events for image ${e+1}, waiting for upload...`),await this.delay(2e3,3e3),i++,a(`Successfully uploaded image ${e+1}/${t.length}`)}catch(t){l(`Failed to upload image ${e+1}:`,t)}}if(0===i)throw new Error("Failed to upload any images");a(`${i}/${t.length} images uploaded successfully`)}async fillTitle(e){}async fillDescription(e){const t=e.length>1e3?e.substring(0,1e3):e,i=await this.waitForElement('textarea#description[name="description"]');await this.typeText(i,t)}async selectCategory(e,t){try{const i=await this.waitForElement('input#group-input[role="combobox"]');if(await this.clickElement(i),await this.delay(1e3,1500),e){const t=document.querySelectorAll('ul#group-menu li[role="option"]');a(`Found ${t.length} category options`);for(const i of Array.from(t)){const t=i.textContent?.trim()||"";if(t.toLowerCase().includes(e.toLowerCase())){a(`Selecting category: ${t}`),await this.clickElement(i),await this.delay(1e3,1500);break}}}else{const e=document.querySelector('ul#group-menu li[role="option"]');e&&(await this.clickElement(e),await this.delay(1e3,1500))}if(t){await this.delay(1e3,1500);const e=await this.waitForElement('input#productType-input[role="combobox"]',5e3);await this.clickElement(e),await this.delay(1e3,1500);const i=document.querySelectorAll('ul#productType-menu li[role="option"]');a(`Found ${i.length} subcategory options`);for(const e of Array.from(i)){const i=e.textContent?.trim()||"";if(i.toLowerCase().includes(t.toLowerCase())){a(`Selecting subcategory: ${i}`),await this.clickElement(e),await this.delay(500,1e3);break}}}}catch(e){throw n("Failed to select category:",e),e}}async fillBrand(e){try{const t=await this.waitForElement('input#brand-input[role="combobox"]');if(e){await this.typeText(t,e),await this.delay(500,1e3);const i=document.querySelectorAll('ul#brand-menu li[role="option"]');i.length>0&&(a("Selecting first brand option"),await this.clickElement(i[0]))}else{await this.typeText(t,"No brand"),await this.delay(500,1e3);const e=document.querySelectorAll('ul#brand-menu li[role="option"]');e.length>0&&await this.clickElement(e[0])}}catch(e){throw n("Failed to fill brand:",e),e}}async selectSize(e){if(e)try{const t=await this.waitForElement('input#variants-input[role="combobox"]',5e3);await this.clickElement(t),await this.delay(500,1e3);const i=document.querySelectorAll('ul#variants-menu li[role="option"]');a(`Found ${i.length} size options`);for(const t of Array.from(i)){const i=t.textContent?.toLowerCase()||"";if(i.includes(e.toLowerCase()))return a(`Selecting size: ${i}`),void await this.clickElement(t)}i.length>0&&(n(`Size "${e}" not found, selecting first option`),await this.clickElement(i[0]))}catch(e){a("Size field not found or failed to select - skipping (optional)")}}async selectColor(e){if(e)try{const t=await this.waitForElement('input#colour-input[role="combobox"]',5e3);await this.clickElement(t),await this.delay(500,1e3);const i=document.querySelectorAll('ul#colour-menu li[role="option"]');a(`Found ${i.length} color options`);for(const t of Array.from(i)){const i=t.textContent?.toLowerCase()||"";if(i.includes(e.toLowerCase()))return a(`Selecting color: ${i}`),void await this.clickElement(t)}n(`Color "${e}" not found in options`)}catch(e){a("Color field not found or failed to select - skipping (optional)")}}async selectCondition(e){const t=i.CONDITIONS[e]||i.CONDITIONS.good;try{const e=await this.waitForElement('input#condition-input[role="combobox"]');await this.clickElement(e),await this.delay(500,1e3);const i=document.querySelectorAll('ul#condition-menu li[role="option"]');a(`Found ${i.length} condition options`);for(const e of Array.from(i)){const i=e.textContent?.trim()||"";if(i.toLowerCase()===t.label.toLowerCase())return a(`Selecting condition: ${i}`),void await this.clickElement(e)}for(const e of Array.from(i)){const i=e.textContent?.toLowerCase()||"";if(i.includes(t.label.toLowerCase()))return a(`Selecting condition (partial match): ${i}`),void await this.clickElement(e)}for(const e of Array.from(i))if((e.textContent?.toLowerCase()||"").includes("good"))return n("Using default condition: Good"),void await this.clickElement(e)}catch(e){throw n("Failed to select condition:",e),e}}async fillPrice(e){try{const t=await this.waitForElement('input[data-testid="priceAmount__input"]');t.focus(),await this.delay(100,200),t.select(),t.value=e.toFixed(2),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(300,500),t.blur(),a("Price set to:",t.value)}catch(e){throw n("Failed to fill price:",e),e}}async selectShipping(e,t){try{const i=16*(e||0)+(t||0),o=i/16;let l="Medium";l=i<4?"Extra extra small":i<8?"Extra small":i<12?"Small":o<1?"Medium":o<2?"Large":"Extra large",a(`Selecting parcel size: ${l} (${o.toFixed(2)} lb)`);const s=await this.waitForElement('input#shippingMethods-input[role="combobox"]');await this.clickElement(s),await this.delay(500,1e3);const r=document.querySelectorAll('ul#shippingMethods-menu li[role="option"]');a(`Found ${r.length} shipping options`);for(const e of Array.from(r))if((e.textContent?.toLowerCase()||"").includes(l.toLowerCase()))return a(`Selecting shipping option: ${l}`),void await this.clickElement(e);for(const e of Array.from(r))if((e.textContent?.toLowerCase()||"").includes("medium"))return n("Using default parcel size: Medium"),void await this.clickElement(e)}catch(e){throw n("Failed to select shipping:",e),e}}async submitListing(){try{const e=await this.waitForElement('button[type="submit"]',1e4);a("Found Post button, clicking..."),await this.clickElement(e),await this.delay(3e3,5e3);const t=window.location.href;a("Current URL after submission:",t);const i=t.match(/\/products\/([a-zA-Z0-9_-]+)/),o=i?i[1]:"success";return a("Listing submitted successfully:",{platformListingId:o,platformUrl:t}),{platformListingId:o,platformUrl:t}}catch(e){throw l("Failed to submit listing:",e),e}}async createListing(e){try{a("Starting Depop listing creation for:",e.title),a("Listing data received:",JSON.stringify(e)),a("Photo URLs:",e.photo_urls),await this.uploadImages(e.photo_urls),await this.fillTitle(e.title),await this.fillDescription(e.description),await this.selectCategory(e.depop_category||e.category,e.depop_subcategory||null),await this.fillBrand(e.brand),await this.selectSize(e.size),await this.selectColor(e.color),await this.selectCondition(e.condition),await this.fillPrice(e.price),await this.selectShipping(e.weight_lb,e.weight_oz),a("Waiting for form to be ready for submission..."),await this.delay(2e3,3e3);const t=await this.submitListing();return{success:!0,listingId:e.id,platform:"depop",platformListingId:t.platformListingId,platformUrl:t.platformUrl}}catch(t){return l("Failed to create Depop listing:",t),{success:!1,listingId:e.id,platform:"depop",error:t instanceof Error?t.message:"Unknown error"}}}};chrome.runtime.onMessage.addListener((e,t,i)=>{if(e.type,"CREATE_LISTING"===e.type){const{listingData:t}=e.payload;return s.createListing(t).then(e=>{i(e)}).catch(e=>{i({success:!1,listingId:t.id,platform:"depop",error:e.message})}),!0}if("CHECK_LOGIN"===e.type){const e=!!document.querySelector('[data-testid="user-menu"], [class*="UserMenu"], [class*="user-menu" i]')||!(window.location.pathname.includes("/login")||!document.querySelector('[href*="/sell"], [class*="sell" i]'));return a("Depop login status:",e),i({loggedIn:e}),!0}}),a("Depop content script loaded")})();