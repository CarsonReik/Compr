(()=>{"use strict";var t,e,a;!function(t){t.CONDITIONS={new:{value:"nwt",label:"NWT (New With Tags)"},like_new:{value:"nwot",label:"NWOT (New Without Tags)"},good:{value:"good",label:"Good - Used"},fair:{value:"fair",label:"Fair - Used"},poor:{value:"poor",label:"Poor - Used"}}}(t||(t={})),function(t){t.CONDITIONS={new:{value:"new",label:"New"},like_new:{value:"like_new",label:"Like New"},good:{value:"good",label:"Good"},fair:{value:"fair",label:"Fair"},poor:{value:"poor",label:"Poor"}}}(e||(e={})),function(t){t.CONDITIONS={new:{value:"brand_new",label:"Brand new"},like_new:{value:"like_new",label:"Like new"},good:{value:"used_excellent",label:"Used - Excellent"},fair:{value:"used_good",label:"Used - Good"},poor:{value:"used_fair",label:"Used - Fair"}},t.PARCEL_SIZES={extra_extra_small:{maxOz:4,label:"Extra extra small",price:4.99},extra_small:{maxOz:8,label:"Extra small",price:5.99},small:{maxOz:12,label:"Small",price:6.49},medium:{maxLb:1,label:"Medium",price:7.99},large:{maxLb:2,label:"Large",price:11.99},extra_large:{maxLb:10,label:"Extra large",price:13.99}}}(a||(a={})),Error;const i=(...t)=>{},n=(...t)=>{console.info("[Compr Extension]",...t)},o=(...t)=>{console.warn("[Compr Extension]",...t)},l=(...t)=>{console.error("[Compr Extension]",...t)},s=new class{delay(t,e){const a=Math.floor(Math.random()*(e-t+1))+t;return new Promise(t=>setTimeout(t,a))}async typeText(t,e){t.focus(),t.value="";for(const a of e)t.value+=a,t.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(50,150);t.dispatchEvent(new Event("change",{bubbles:!0})),t.blur()}async clickElement(t){await this.delay(500,2e3),t.scrollIntoView({behavior:"smooth",block:"center"}),await this.delay(200,500),t.click()}async waitForElement(t,e=1e4){const a=Date.now();for(;Date.now()-a<e;){const e=document.querySelector(t);if(e)return e;await this.delay(100,300)}throw new Error(`Element not found: ${t}`)}async downloadImage(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to download image: ${e.statusText}`);return await e.blob()}async uploadImages(t){if(!t||0===t.length)return void o("No photo URLs provided, skipping image upload");n(`Uploading ${t.length} images to Poshmark`,t);const e=t.slice(0,16);let a=0;for(let t=0;t<e.length;t++){i((e.length,e[t]));try{const i=await this.waitForElement('input#img-file-input[type="file"]');n("Found file input:",i),n(`Downloading image from: ${e[t]}`);const l=await this.downloadImage(e[t]);n(`Downloaded blob: size=${l.size}, type=${l.type}`);const s=`image-${t+1}.jpg`,r=new File([l],s,{type:l.type||"image/jpeg"});n(`Created file: name=${r.name}, size=${r.size}, type=${r.type}`);const c=new DataTransfer;c.items.add(r),n(`DataTransfer files: ${c.files.length}`),i.files=c.files;const d=["input","change","blur"];for(const t of d)i.dispatchEvent(new Event(t,{bubbles:!0}));n(`Triggered events for image ${t+1}, waiting for upload...`),await this.delay(1500,2e3);try{const t=await this.waitForElement('button[data-et-name="apply"]',5e3);n("Found Apply button, clicking..."),await this.clickElement(t),await this.delay(500,1e3)}catch(t){o("Could not find Apply button:",t)}a++,n(`Successfully uploaded image ${t+1}/${e.length}`)}catch(e){l(`Failed to upload image ${t+1}:`,e)}}if(0===a)throw new Error("Failed to upload any images");n(`${a}/${e.length} images uploaded successfully`)}async fillTitle(t){const e=await this.waitForElement('input[data-vv-name="title"]');await this.typeText(e,t)}async fillDescription(t){const e=await this.waitForElement('textarea[data-vv-name="description"]');await this.typeText(e,t)}async selectCategory(t){try{const t=document.querySelectorAll(".dropdown__selector--select-tag");let e=null;for(const a of Array.from(t))if(a.textContent?.includes("Select Category")){e=a;break}if(!e)throw new Error("Category selector not found");await this.clickElement(e),await this.delay(1500,2e3);const a=document.querySelectorAll("a.dropdown__menu__item");n(`Found ${a.length} dropdown items`);const i=Array.from(a).filter(t=>{const e=t.textContent?.toLowerCase().trim()||"";return e&&!e.includes("all categories")&&!e.includes("done")&&e.length>2});if(i.length>0){n(`Found ${i.length} category options:`,i.map(t=>t.textContent?.trim()));let t=i[0];for(const e of i)if((e.textContent?.toLowerCase()||"").includes("women")){t=e;break}n(`Selecting department: ${t.textContent?.trim()}`),await this.clickElement(t),await this.delay(1500,2e3);const e=document.querySelectorAll("li.dropdown__menu__item, a.dropdown__menu__item"),a=Array.from(e).filter(t=>{const e=t.textContent?.toLowerCase().trim()||"";return e&&!e.includes("all")&&e.length>2});if(a.length>0){n(`Found ${a.length} level 2 category options`);let t=a[a.length-1];for(const e of a)if("other"===(e.textContent?.toLowerCase().trim()||"")){t=e;break}n(`Selecting level 2 category: ${t.textContent?.trim()}`),await this.clickElement(t),await this.delay(1e3,1500);const e=document.querySelectorAll("li.dropdown__menu__item, a.dropdown__menu__item"),i=Array.from(e).filter(t=>{const e=t.textContent?.toLowerCase().trim()||"";return e&&!e.includes("all")&&!e.includes("done")&&e.length>2});i.length>0&&(n(`Found ${i.length} level 3 subcategory options, selecting first one: ${i[0].textContent?.trim()}`),await this.clickElement(i[0]))}}else o("No category options found in dropdown")}catch(t){o("Failed to select category:",t)}}async fillBrand(t){if(t)try{const e=await this.waitForElement('input[name="brand"], input[placeholder*="Brand"], input[data-test="brand"]');await this.typeText(e,t),await this.delay(500,1e3);const a=document.querySelector('[data-test="brand-suggestion"]:first-child, .autocomplete-option:first-child');a&&await this.clickElement(a)}catch(t){o("Failed to fill brand:",t)}}async fillSize(t){try{if(t)try{const e=await this.waitForElement(`button#size-${t}`,3e3);return n(`Found size button for "${t}", clicking...`),await this.clickElement(e),await this.delay(500,700),void n(`Size "${t}" selected via button`)}catch{}const e=await this.waitForElement('[data-test="size"]');if(await this.clickElement(e),await this.delay(500,1e3),t){const e=document.querySelectorAll('[data-test="size-option"], .dropdown__menu .dropdown__menu-item');for(const a of Array.from(e))if(a.textContent?.toLowerCase().includes(t.toLowerCase()))return void await this.clickElement(a);o(`Size "${t}" not found, selecting first option`);const a=e[0];a&&await this.clickElement(a)}else{const t=document.querySelector('[data-test="size-option"], .dropdown__menu .dropdown__menu-item:first-child');t&&await this.clickElement(t)}}catch(t){o("Failed to fill size:",t)}}async selectColors(t){if(t&&0!==t.length){n(`Selecting ${t.length} color(s):`,t);try{const e=await this.waitForElement('[data-et-name="color"]',5e3);await this.clickElement(e),await this.delay(1e3,1500);const a=t.slice(0,2);let l=0;for(const t of a)try{const e=document.querySelectorAll(".listing-editor__tile--color");i(e.length);for(const a of Array.from(e)){const e=a.querySelector("span")?.textContent?.trim();if(e&&e.toLowerCase()===t.toLowerCase()){const t=a.querySelector("a.color__circle--large");if(t){n(`Clicking color: ${e}`),await this.clickElement(t),await this.delay(500,700),l++;break}}}}catch(e){o(`Failed to select color "${t}":`,e)}n(`Successfully selected ${l} color(s)`)}catch(t){l("Failed to open color dropdown:",t)}}}async selectCondition(e){const a=t.CONDITIONS[e]||t.CONDITIONS.good;try{const t=await this.waitForElement('select[name="condition"], [data-test="condition-select"]'),e=Array.from(t.querySelectorAll("option")).find(t=>t.value===a.value||t.textContent?.includes(a.label));e&&(t.value=e.value,t.dispatchEvent(new Event("change",{bubbles:!0})))}catch(t){o("Failed to select condition:",t)}}async selectNewWithTags(t){if(t){n("Selecting New With Tags (NWT)");try{const t=await this.waitForElement('button[data-et-name="nwt_yes"]',5e3);await this.clickElement(t),await this.delay(500,700),n("NWT selected successfully")}catch(t){o("Failed to select NWT:",t)}}}async setQuantity(t,e){if(t<=1);else{n(`Setting multi-item quantity: ${t}`);try{const e=await this.waitForElement('button[data-et-name="multiple"]',5e3);await this.clickElement(e),await this.delay(1e3,1500);const a=await this.waitForElement('input[data-vv-name="quantityAvailable0"]',5e3);a.value=String(t),a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(300,500),n(`Quantity set to: ${t}`)}catch(t){o("Failed to set quantity:",t)}}}async fillOriginalPrice(t){try{const e=await this.waitForElement('input[data-vv-name="originalPrice"]');e.focus(),await this.delay(100,200),e.value="",e.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(100,200);const a=String(Math.ceil(t));e.value=a,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(200,300),e.blur(),await this.delay(200,300),n("Original price set to:",e.value)}catch(t){o("Failed to fill original price:",t)}}async fillPrice(t){const e=await this.waitForElement('input[data-vv-name="listingPrice"]');e.focus(),await this.delay(100,200),e.value="",e.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(100,200);const a=String(Math.ceil(t));e.value=a,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(200,300),e.blur(),await this.delay(200,300),n("Listing price set to:",e.value)}async submitListing(){const t=await this.waitForElement('button[data-et-name="next"]');n("Found Next button, clicking to open confirmation modal..."),await this.clickElement(t),await this.delay(1500,2e3);const e=await this.waitForElement('button[data-et-name="list"]');n("Found List This Item button, clicking to submit listing..."),await this.clickElement(e),await this.delay(3e3,5e3);const a=window.location.href;if(a.includes("/feed"))return n("Redirected to feed - listing submitted successfully"),{platformListingId:"success",platformUrl:"https://poshmark.com/feed"};const i=a.split("/"),o=i[i.length-1],l=o.split("-").pop()||o;return n("Listing submitted successfully:",{platformListingId:l,platformUrl:a}),{platformListingId:l,platformUrl:a}}async createListing(t){try{n("Starting listing creation for:",t.title),n("Listing data received:",JSON.stringify(t)),n("Photo URLs:",t.photo_urls),await this.uploadImages(t.photo_urls),await this.fillTitle(t.title),await this.fillDescription(t.description),await this.selectCategory(t.poshmark_category||t.category),await this.fillBrand(t.brand),await this.fillSize(t.size),t.poshmark_color&&t.poshmark_color.length>0&&await this.selectColors(t.poshmark_color),await this.selectCondition(t.condition),t.poshmark_new_with_tags&&await this.selectNewWithTags(!0),await this.fillOriginalPrice(t.original_price||t.price),await this.fillPrice(t.price),t.quantity&&t.quantity>1&&await this.setQuantity(t.quantity,t.size||"");const e=await this.submitListing();return{success:!0,listingId:t.id,platform:"poshmark",platformListingId:e.platformListingId,platformUrl:e.platformUrl}}catch(e){return l("Failed to create listing:",e),{success:!1,listingId:t.id,platform:"poshmark",error:e instanceof Error?e.message:"Unknown error"}}}};function r(){return!("/feed"!==window.location.pathname&&!window.location.pathname.includes("/closet/"))||!!document.querySelector('[data-test="user-menu"], [class*="user-menu" i], [class*="profile" i]')}chrome.runtime.onMessage.addListener((t,e,a)=>{if(t.type,"CREATE_LISTING"===t.type){const{listingData:e}=t.payload;return s.createListing(e).then(t=>{a(t)}).catch(t=>{a({success:!1,listingId:e.id,platform:"poshmark",error:t.message})}),!0}if("ATTEMPT_LOGIN"===t.type){const{username:e,password:i}=t.payload;return async function(t,e){try{if(n("Attempting Poshmark login for:",t),await s.delay(2e3,3e3),r())return n("User is already logged in to Poshmark"),{success:!0};window.location.pathname.includes("/login")||(o("Not on login page, redirecting..."),window.location.href="https://poshmark.com/login",await s.delay(2e3,3e3));const a=await s.waitForElement('input[name="login_form[username_email]"], input[type="email"], input[placeholder*="email" i], input[placeholder*="username" i]',1e4);await s.typeText(a,t);const i=await s.waitForElement('input[name="login_form[password]"], input[type="password"]',5e3);await s.typeText(i,e);const l=await s.waitForElement('button[type="submit"], button[data-et-name="submit"]',5e3);if(await s.clickElement(l),await s.delay(3e3,5e3),r())return n("Poshmark login successful"),{success:!0};const c=document.querySelector('.error-msg, .alert-error, [class*="error"], [role="alert"]');if(c&&c.textContent){const t=c.textContent.trim();if(t.length>0)return o("Poshmark login failed:",t),{success:!1,error:t}}return window.location.pathname.includes("/login")?{success:!1,error:"Invalid username or password"}:{success:!0}}catch(t){return l("Poshmark login error:",t),{success:!1,error:t instanceof Error?t.message:"Login failed"}}}(e,i).then(t=>{a(t)}).catch(t=>{a({success:!1,error:t.message})}),!0}}),n("Poshmark content script loaded")})();