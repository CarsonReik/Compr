(()=>{"use strict";var e,t,i;!function(e){e.CONDITIONS={new:{value:"nwt",label:"NWT (New With Tags)"},like_new:{value:"nwot",label:"NWOT (New Without Tags)"},good:{value:"good",label:"Good - Used"},fair:{value:"fair",label:"Fair - Used"},poor:{value:"poor",label:"Poor - Used"}}}(e||(e={})),function(e){e.CONDITIONS={new:{value:"new",label:"New"},like_new:{value:"like_new",label:"Like New"},good:{value:"good",label:"Good"},fair:{value:"fair",label:"Fair"},poor:{value:"poor",label:"Poor"}}}(t||(t={})),function(e){e.CONDITIONS={new:{value:"brand_new",label:"Brand new"},like_new:{value:"like_new",label:"Like new"},good:{value:"used_excellent",label:"Used - Excellent"},fair:{value:"used_good",label:"Used - Good"},poor:{value:"used_fair",label:"Used - Fair"}},e.PARCEL_SIZES={extra_extra_small:{maxOz:4,label:"Extra extra small",price:4.99},extra_small:{maxOz:8,label:"Extra small",price:5.99},small:{maxOz:12,label:"Small",price:6.49},medium:{maxLb:1,label:"Medium",price:7.99},large:{maxLb:2,label:"Large",price:11.99},extra_large:{maxLb:10,label:"Extra large",price:13.99}}}(i||(i={})),Error;const n=(...e)=>{},a=(...e)=>{console.info("[Compr Extension]",...e)},o=(...e)=>{console.warn("[Compr Extension]",...e)},l=(...e)=>{console.error("[Compr Extension]",...e)};function s(){return document.hidden}function r(e,t,i=!1){if(s()){const e=i?10:0;return 0===e?Promise.resolve():new Promise(t=>setTimeout(t,e))}{const i=Math.floor(Math.random()*(t-e+1))+e;return new Promise(e=>setTimeout(e,i))}}const c=new class{delay(e,t){return r(e,t)}async typeText(e,t){if(e.focus(),e.value="",s())e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),await r(10,20,!0);else{for(const i of t)e.value+=i,e.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(50,150);e.dispatchEvent(new Event("change",{bubbles:!0}))}e.blur()}async clickElement(e){await this.delay(500,2e3),e.scrollIntoView({behavior:s()?"auto":"smooth",block:"center"}),await this.delay(200,500),e.click()}async waitForElement(e,t=1e4){return document.querySelector(e)||new Promise((i,n)=>{const a=setTimeout(()=>{o.disconnect(),n(new Error(`Element not found: ${e}`))},t),o=new MutationObserver(()=>{const t=document.querySelector(e);t&&(clearTimeout(a),o.disconnect(),i(t))});o.observe(document.body,{childList:!0,subtree:!0})})}async checkLoginStatus(){try{if(window.location.href.includes("/login")||window.location.href.includes("/signup"))return l("Redirected to login page - user is not logged in"),!1;const e=document.querySelector('a[href*="/login"]'),t=document.querySelector('a[href*="/signup"]');return e||t?(l("Login/signup buttons found - user is not logged in"),!1):document.querySelector('[data-et-name="user_menu"]')||document.querySelector('[data-et-name="profile"]')||document.querySelector('button[aria-label*="account" i]')||document.querySelector(".header__user-menu")?(a("User menu found - user is logged in"),!0):window.location.pathname.includes("/create-listing")?(a("On /create-listing page without login prompts - assuming logged in"),!0):(o("Could not definitively determine login status - proceeding cautiously"),!0)}catch(e){return l("Error checking login status:",e),!0}}async downloadImage(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to download image: ${t.statusText}`);return await t.blob()}async uploadImages(e){if(!e||0===e.length)return void o("No photo URLs provided, skipping image upload");a(`Uploading ${e.length} images to Poshmark`,e);const t=e.slice(0,16);let i=0;for(let e=0;e<t.length;e++){n((t.length,t[e]));try{const n=await this.waitForElement('input#img-file-input[type="file"]');a("Found file input:",n),a(`Downloading image from: ${t[e]}`);const l=await this.downloadImage(t[e]);a(`Downloaded blob: size=${l.size}, type=${l.type}`);const s=`image-${e+1}.jpg`,r=new File([l],s,{type:l.type||"image/jpeg"});a(`Created file: name=${r.name}, size=${r.size}, type=${r.type}`);const c=new DataTransfer;c.items.add(r),a(`DataTransfer files: ${c.files.length}`),n.files=c.files;const u=["input","change","blur"];for(const e of u)n.dispatchEvent(new Event(e,{bubbles:!0}));a(`Triggered events for image ${e+1}, waiting for upload...`),await this.delay(1500,2e3);try{const e=await this.waitForElement('button[data-et-name="apply"]',5e3);a("Found Apply button, clicking..."),await this.clickElement(e),await this.delay(500,1e3)}catch(e){o("Could not find Apply button:",e)}i++,a(`Successfully uploaded image ${e+1}/${t.length}`)}catch(t){l(`Failed to upload image ${e+1}:`,t)}}if(0===i)throw new Error("Failed to upload any images");a(`${i}/${t.length} images uploaded successfully`)}async fillTitle(e){const t=await this.waitForElement('input[data-vv-name="title"]');await this.typeText(t,e)}async fillDescription(e){const t=await this.waitForElement('textarea[data-vv-name="description"]');await this.typeText(t,e)}async selectCategory(e){try{const e=document.querySelectorAll(".dropdown__selector--select-tag");let t=null;for(const i of Array.from(e))if(i.textContent?.includes("Select Category")){t=i;break}if(!t)throw new Error("Category selector not found");await this.clickElement(t),await this.delay(1500,2e3);const i=document.querySelectorAll("a.dropdown__menu__item");a(`Found ${i.length} dropdown items`);const n=Array.from(i).filter(e=>{const t=e.textContent?.toLowerCase().trim()||"";return t&&!t.includes("all categories")&&!t.includes("done")&&t.length>2});if(n.length>0){a(`Found ${n.length} category options:`,n.map(e=>e.textContent?.trim()));let e=n[0];for(const t of n)if((t.textContent?.toLowerCase()||"").includes("women")){e=t;break}a(`Selecting department: ${e.textContent?.trim()}`),await this.clickElement(e),await this.delay(1500,2e3);const t=document.querySelectorAll("li.dropdown__menu__item, a.dropdown__menu__item"),i=Array.from(t).filter(e=>{const t=e.textContent?.toLowerCase().trim()||"";return t&&!t.includes("all")&&t.length>2});if(i.length>0){a(`Found ${i.length} level 2 category options`);let e=i[i.length-1];for(const t of i)if("other"===(t.textContent?.toLowerCase().trim()||"")){e=t;break}a(`Selecting level 2 category: ${e.textContent?.trim()}`),await this.clickElement(e),await this.delay(1e3,1500);const t=document.querySelectorAll("li.dropdown__menu__item, a.dropdown__menu__item"),n=Array.from(t).filter(e=>{const t=e.textContent?.toLowerCase().trim()||"";return t&&!t.includes("all")&&!t.includes("done")&&t.length>2});n.length>0&&(a(`Found ${n.length} level 3 subcategory options, selecting first one: ${n[0].textContent?.trim()}`),await this.clickElement(n[0]))}}else o("No category options found in dropdown")}catch(e){o("Failed to select category:",e)}}async fillBrand(e){if(e)try{const t=await this.waitForElement('input[name="brand"], input[placeholder*="Brand"], input[data-test="brand"]');await this.typeText(t,e),await this.delay(500,1e3);const i=document.querySelector('[data-test="brand-suggestion"]:first-child, .autocomplete-option:first-child');i&&await this.clickElement(i)}catch(e){o("Failed to fill brand:",e)}}async fillSize(e){try{if(e)try{const t=await this.waitForElement(`button#size-${e}`,3e3);return a(`Found size button for "${e}", clicking...`),await this.clickElement(t),await this.delay(500,700),void a(`Size "${e}" selected via button`)}catch{}const t=await this.waitForElement('[data-test="size"]');if(await this.clickElement(t),await this.delay(500,1e3),e){const t=document.querySelectorAll('[data-test="size-option"], .dropdown__menu .dropdown__menu-item');for(const i of Array.from(t))if(i.textContent?.toLowerCase().includes(e.toLowerCase()))return void await this.clickElement(i);o(`Size "${e}" not found, selecting first option`);const i=t[0];i&&await this.clickElement(i)}else{const e=document.querySelector('[data-test="size-option"], .dropdown__menu .dropdown__menu-item:first-child');e&&await this.clickElement(e)}}catch(e){o("Failed to fill size:",e)}}async selectColors(e){if(e&&0!==e.length){a(`Selecting ${e.length} color(s):`,e);try{const t=await this.waitForElement('[data-et-name="color"]',5e3);await this.clickElement(t),await this.delay(1e3,1500);const i=e.slice(0,2);let l=0;for(const e of i)try{const t=document.querySelectorAll(".listing-editor__tile--color");n(t.length);for(const i of Array.from(t)){const t=i.querySelector("span")?.textContent?.trim();if(t&&t.toLowerCase()===e.toLowerCase()){const e=i.querySelector("a.color__circle--large");if(e){a(`Clicking color: ${t}`),await this.clickElement(e),await this.delay(500,700),l++;break}}}}catch(t){o(`Failed to select color "${e}":`,t)}a(`Successfully selected ${l} color(s)`)}catch(e){l("Failed to open color dropdown:",e)}}}async selectCondition(t){const i=e.CONDITIONS[t]||e.CONDITIONS.good;try{const e=await this.waitForElement('select[name="condition"], [data-test="condition-select"]'),t=Array.from(e.querySelectorAll("option")).find(e=>e.value===i.value||e.textContent?.includes(i.label));t&&(e.value=t.value,e.dispatchEvent(new Event("change",{bubbles:!0})))}catch(e){o("Failed to select condition:",e)}}async selectNewWithTags(e){if(e){a("Selecting New With Tags (NWT)");try{const e=await this.waitForElement('button[data-et-name="nwt_yes"]',5e3);await this.clickElement(e),await this.delay(500,700),a("NWT selected successfully")}catch(e){o("Failed to select NWT:",e)}}}async setQuantity(e,t){if(e<=1);else{a(`Setting multi-item quantity: ${e}`);try{const t=await this.waitForElement('button[data-et-name="multiple"]',5e3);await this.clickElement(t),await this.delay(1e3,1500);const i=await this.waitForElement('input[data-vv-name="quantityAvailable0"]',5e3);i.value=String(e),i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(300,500),a(`Quantity set to: ${e}`)}catch(e){o("Failed to set quantity:",e)}}}async fillOriginalPrice(e){try{const t=await this.waitForElement('input[data-vv-name="originalPrice"]');t.focus(),await this.delay(100,200),t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(100,200);const i=String(Math.ceil(e));t.value=i,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(200,300),t.blur(),await this.delay(200,300),a("Original price set to:",t.value)}catch(e){o("Failed to fill original price:",e)}}async fillPrice(e){const t=await this.waitForElement('input[data-vv-name="listingPrice"]');t.focus(),await this.delay(100,200),t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(100,200);const i=String(Math.ceil(e));t.value=i,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(200,300),t.blur(),await this.delay(200,300),a("Listing price set to:",t.value)}async submitListing(){const e=await this.waitForElement('button[data-et-name="next"]');a("Found Next button, clicking to open confirmation modal..."),await this.clickElement(e),await this.delay(1500,2e3);const t=await this.waitForElement('button[data-et-name="list"]');a("Found List This Item button, clicking to submit listing..."),await this.clickElement(t),await new Promise(e=>setTimeout(e,4e3));const i=window.location.href;if(i.includes("/feed"))return a("Redirected to feed - listing submitted successfully"),{platformListingId:"success",platformUrl:"https://poshmark.com/feed"};const n=i.split("/"),o=n[n.length-1],l=o.split("-").pop()||o;return a("Listing submitted successfully:",{platformListingId:l,platformUrl:i}),{platformListingId:l,platformUrl:i}}async createListing(e){try{if(a("Starting listing creation for:",e.title),a("Listing data received:",JSON.stringify(e)),a("Photo URLs:",e.photo_urls),a("Checking Poshmark login status..."),!await this.checkLoginStatus())throw new Error("Not logged in to Poshmark. Please log in at poshmark.com and try again.");a("Login check passed - proceeding with listing creation"),await this.uploadImages(e.photo_urls),await this.fillTitle(e.title),await this.fillDescription(e.description),await this.selectCategory(e.poshmark_category||e.category),await this.fillBrand(e.brand),await this.fillSize(e.size),e.poshmark_color&&e.poshmark_color.length>0&&await this.selectColors(e.poshmark_color),await this.selectCondition(e.condition),e.poshmark_new_with_tags&&await this.selectNewWithTags(!0),await this.fillOriginalPrice(e.original_price||e.price),await this.fillPrice(e.price),e.quantity&&e.quantity>1&&await this.setQuantity(e.quantity,e.size||"");const t=await this.submitListing();return{success:!0,listingId:e.id,platform:"poshmark",platformListingId:t.platformListingId,platformUrl:t.platformUrl}}catch(t){return l("Failed to create listing:",t),{success:!1,listingId:e.id,platform:"poshmark",error:t instanceof Error?t.message:"Unknown error"}}}};chrome.runtime.onMessage.addListener((e,t,i)=>{if(e.type,"CREATE_LISTING"===e.type){const{listingData:t}=e.payload;return c.createListing(t).then(e=>{i(e)}).catch(e=>{i({success:!1,listingId:t.id,platform:"poshmark",error:e.message})}),!0}if("CHECK_LOGIN"===e.type){const e=function(){console.log("[Poshmark] Checking login status...");const e=document.querySelector('a[href*="/login"]'),t=document.querySelector('a[href*="/signup"]'),i=Array.from(document.querySelectorAll("button, a")),n=i.some(e=>{const t=e.textContent?.toLowerCase()||"";return t.includes("log in")||t.includes("login")||t.includes("sign in")}),a=i.some(e=>{const t=e.textContent?.toLowerCase()||"";return t.includes("sign up")||t.includes("signup")}),o=document.querySelector('form[action*="login"], input[type="email"][name*="login"]'),l=document.querySelector('input[type="password"]');if(e||t||n||a||o&&l)return console.log("[Poshmark] Found login indicators - NOT logged in"),!1;const s=window.location.pathname.toLowerCase();return s.includes("/login")||s.includes("/signup")?(console.log("[Poshmark] On login page - NOT logged in"),!1):document.querySelector('[data-test="user-menu"], [class*="UserMenu"], [aria-label*="user menu"]')?(console.log("[Poshmark] Found user menu - logged in"),!0):"/feed"===s||s.includes("/closet/")||s.includes("/mywallet")?(console.log("[Poshmark] On authenticated path - logged in"),!0):document.querySelector('[data-test="notifications"], [aria-label*="notification"]')?(console.log("[Poshmark] Found notifications - logged in"),!0):document.querySelector('[data-test="sell-button"], header a[href="/sell"]')&&!e?(console.log("[Poshmark] Found sell button - logged in"),!0):(console.log("[Poshmark] No clear indicators - NOT logged in"),!1)}();return a("Poshmark login status:",e),i({loggedIn:e}),!0}}),a("Poshmark content script loaded")})();