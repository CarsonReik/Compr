(()=>{"use strict";const e=(...e)=>{},t=(...e)=>{console.info("[Compr Extension]",...e)},i=(...e)=>{console.warn("[Compr Extension]",...e)},o=(...e)=>{console.error("[Compr Extension]",...e)},r=[{keywords:["leggings","yoga pants","tights","athletic pants"],category:{tier1:"Women",tier2:"Athletic Apparel",tier3:"Pants, Tights, Leggings"}},{keywords:["athletic shorts","running shorts","yoga shorts","bike shorts"],category:{tier1:"Women",tier2:"Athletic Apparel",tier3:"Shorts"}},{keywords:["sports bra","athletic top","workout top","gym top"],category:{tier1:"Women",tier2:"Athletic Apparel",tier3:"Tops"}},{keywords:["activewear","athletic","workout","gym","yoga","fitness"],category:{tier1:"Women",tier2:"Athletic Apparel"}},{keywords:["t-shirt","tee","tshirt"],category:{tier1:"Women",tier2:"Tops & Blouses",tier3:"T-Shirts"}},{keywords:["tank top","cami","camisole"],category:{tier1:"Women",tier2:"Tops & Blouses",tier3:"Tank, Cami"}},{keywords:["blouse","dress shirt"],category:{tier1:"Women",tier2:"Tops & Blouses",tier3:"Blouses"}},{keywords:["top","shirt","tunic"],category:{tier1:"Women",tier2:"Tops & Blouses"}},{keywords:["mini dress","short dress"],category:{tier1:"Women",tier2:"Dresses",tier3:"Mini"}},{keywords:["midi dress","knee length dress"],category:{tier1:"Women",tier2:"Dresses",tier3:"Midi"}},{keywords:["maxi dress","long dress","floor length"],category:{tier1:"Women",tier2:"Dresses",tier3:"Maxi"}},{keywords:["dress","gown","sundress"],category:{tier1:"Women",tier2:"Dresses"}},{keywords:["sneakers","tennis shoes","running shoes","trainers","athletic shoes"],category:{tier1:"Women",tier2:"Shoes",tier3:"Athletic"}},{keywords:["heels","pumps","stiletto"],category:{tier1:"Women",tier2:"Shoes",tier3:"Heels"}},{keywords:["boots","ankle boots","booties"],category:{tier1:"Women",tier2:"Shoes",tier3:"Boots"}},{keywords:["sandals","flip flops","slides"],category:{tier1:"Women",tier2:"Shoes",tier3:"Sandals"}},{keywords:["flats","ballet flats","loafers"],category:{tier1:"Women",tier2:"Shoes",tier3:"Flats"}},{keywords:["crossbody","crossbody bag","cross body"],category:{tier1:"Women",tier2:"Bags & Purses",tier3:"Crossbody"}},{keywords:["shoulder bag","hobo bag"],category:{tier1:"Women",tier2:"Bags & Purses",tier3:"Shoulder Bag"}},{keywords:["tote","tote bag"],category:{tier1:"Women",tier2:"Bags & Purses",tier3:"Tote"}},{keywords:["backpack"],category:{tier1:"Women",tier2:"Bags & Purses",tier3:"Backpack"}},{keywords:["wallet","coin purse","wristlet"],category:{tier1:"Women",tier2:"Bags & Purses",tier3:"Wallet"}},{keywords:["clutch"],category:{tier1:"Women",tier2:"Bags & Purses",tier3:"Clutch"}},{keywords:["handbag","purse","bag","satchel"],category:{tier1:"Women",tier2:"Bags & Purses"}},{keywords:["necklace","pendant","chain"],category:{tier1:"Women",tier2:"Jewelry",tier3:"Necklaces"}},{keywords:["earrings","studs","hoops"],category:{tier1:"Women",tier2:"Jewelry",tier3:"Earrings"}},{keywords:["bracelet","bangle"],category:{tier1:"Women",tier2:"Jewelry",tier3:"Bracelets"}},{keywords:["ring","band"],category:{tier1:"Women",tier2:"Jewelry",tier3:"Rings"}},{keywords:["jeans"],category:{tier1:"Women",tier2:"Jeans"}},{keywords:["pants","trousers","slacks"],category:{tier1:"Women",tier2:"Pants"}},{keywords:["skirt","mini skirt","pencil skirt"],category:{tier1:"Women",tier2:"Skirts"}},{keywords:["shorts"],category:{tier1:"Women",tier2:"Shorts"}},{keywords:["jacket","coat","blazer"],category:{tier1:"Women",tier2:"Jackets & Coats"}},{keywords:["sweater","cardigan","pullover"],category:{tier1:"Women",tier2:"Sweaters"}},{keywords:["swimsuit","bikini","swimwear","bathing suit"],category:{tier1:"Women",tier2:"Swim"}},{keywords:["lingerie","bra","underwear","panties","intimates"],category:{tier1:"Women",tier2:"Intimates & Sleepwear"}},{keywords:["foundation","concealer","powder","blush","bronzer","makeup face"],category:{tier1:"Beauty",tier2:"Makeup",tier3:"Face"}},{keywords:["lipstick","lip gloss","lip liner","lip balm"],category:{tier1:"Beauty",tier2:"Makeup",tier3:"Lips"}},{keywords:["eyeshadow","eyeliner","mascara","eye makeup"],category:{tier1:"Beauty",tier2:"Makeup",tier3:"Eyes"}},{keywords:["nail polish","nail","manicure"],category:{tier1:"Beauty",tier2:"Makeup",tier3:"Nails"}},{keywords:["makeup","cosmetics"],category:{tier1:"Beauty",tier2:"Makeup"}},{keywords:["face mask","serum","moisturizer","cleanser","toner"],category:{tier1:"Beauty",tier2:"Skin Care",tier3:"Treatments & Masks"}},{keywords:["skincare","skin care"],category:{tier1:"Beauty",tier2:"Skin Care"}},{keywords:["perfume","cologne","fragrance","eau de"],category:{tier1:"Beauty",tier2:"Fragrance",tier3:"Perfume"}},{keywords:["shampoo","conditioner","hair treatment"],category:{tier1:"Beauty",tier2:"Hair Care",tier3:"Shampoo & Conditioner"}},{keywords:["hair care","hair product"],category:{tier1:"Beauty",tier2:"Hair Care"}},{keywords:["bath","body wash","soap","lotion"],category:{tier1:"Beauty",tier2:"Bath & Body"}},{keywords:["action figure","toy figure"],category:{tier1:"Kids",tier2:"Toys",tier3:"Action Figures & Accessories"}},{keywords:["doll","barbie"],category:{tier1:"Kids",tier2:"Toys",tier3:"Dolls"}},{keywords:["lego","building blocks","construction toy"],category:{tier1:"Kids",tier2:"Toys",tier3:"Building Toys"}},{keywords:["board game","puzzle","game"],category:{tier1:"Kids",tier2:"Toys",tier3:"Games & Puzzles"}},{keywords:["stuffed animal","plush","teddy bear"],category:{tier1:"Kids",tier2:"Toys",tier3:"Stuffed Animals"}},{keywords:["toy","toys"],category:{tier1:"Kids",tier2:"Toys"}},{keywords:["onesie","bodysuit","baby clothes"],category:{tier1:"Kids",tier2:"Baby Clothing",tier3:"Bodysuits"}},{keywords:["baby","infant","toddler"],category:{tier1:"Kids",tier2:"Baby Clothing"}},{keywords:["kids shirt","children shirt","boys shirt","girls shirt"],category:{tier1:"Kids",tier2:"Kids Clothing",tier3:"Tops & T-Shirts"}},{keywords:["kids","child","children","boy","girl"],category:{tier1:"Kids",tier2:"Kids Clothing"}},{keywords:["phone case","iphone case","android case","cell phone case"],category:{tier1:"Electronics",tier2:"Cell Phones & Accessories",tier3:"Cases & Covers"}},{keywords:["unlocked phone","smartphone","cell phone","mobile phone"],category:{tier1:"Electronics",tier2:"Cell Phones & Accessories",tier3:"Unlocked Phones"}},{keywords:["phone","iphone","android"],category:{tier1:"Electronics",tier2:"Cell Phones & Accessories"}},{keywords:["ps5","ps4","playstation","xbox","nintendo switch","console"],category:{tier1:"Electronics",tier2:"Video Games & Consoles",tier3:"Consoles"}},{keywords:["video game","game disc","ps5 game","xbox game","switch game"],category:{tier1:"Electronics",tier2:"Video Games & Consoles",tier3:"Games"}},{keywords:["gaming","video game"],category:{tier1:"Electronics",tier2:"Video Games & Consoles"}},{keywords:["laptop","macbook","notebook computer"],category:{tier1:"Electronics",tier2:"Computers & Tablets",tier3:"Laptops"}},{keywords:["tablet","ipad"],category:{tier1:"Electronics",tier2:"Computers & Tablets",tier3:"Tablets"}},{keywords:["computer","pc"],category:{tier1:"Electronics",tier2:"Computers & Tablets"}},{keywords:["headphones","earbuds","airpods","earphones"],category:{tier1:"Electronics",tier2:"Audio",tier3:"Headphones"}},{keywords:["speaker","bluetooth speaker"],category:{tier1:"Electronics",tier2:"Audio",tier3:"Speakers"}},{keywords:["camera","dslr","canon","nikon"],category:{tier1:"Electronics",tier2:"Cameras & Photography"}},{keywords:["watch","smartwatch","apple watch","fitbit"],category:{tier1:"Electronics",tier2:"Wearables"}},{keywords:["electronics","electronic"],category:{tier1:"Electronics",tier2:"Other"}},{keywords:["men shirt","mens shirt","men's shirt","button down","dress shirt"],category:{tier1:"Men",tier2:"Tops",tier3:"T-Shirts"}},{keywords:["men jeans","mens jeans","men's jeans"],category:{tier1:"Men",tier2:"Bottoms",tier3:"Jeans"}},{keywords:["men pants","mens pants","men's pants","chinos","khakis"],category:{tier1:"Men",tier2:"Bottoms"}},{keywords:["men sneakers","mens sneakers","men's sneakers"],category:{tier1:"Men",tier2:"Shoes",tier3:"Sneakers"}},{keywords:["men shoes","mens shoes","men's shoes"],category:{tier1:"Men",tier2:"Shoes"}},{keywords:["men shorts","mens shorts","men's shorts"],category:{tier1:"Men",tier2:"Athletic Apparel",tier3:"Shorts"}},{keywords:["men jacket","mens jacket","men's jacket","men coat"],category:{tier1:"Men",tier2:"Jackets & Coats"}},{keywords:["men watch","mens watch","men's watch"],category:{tier1:"Men",tier2:"Accessories",tier3:"Watches"}},{keywords:["tie","necktie","bow tie"],category:{tier1:"Men",tier2:"Accessories",tier3:"Ties"}},{keywords:["men","mens","men's","male"],category:{tier1:"Men",tier2:"Other"}},{keywords:["dinnerware","plates","bowls","dishes"],category:{tier1:"Home",tier2:"Kitchen & Dining",tier3:"Dinnerware"}},{keywords:["kitchen storage","food storage"],category:{tier1:"Home",tier2:"Kitchen & Dining",tier3:"Storage & Organization"}},{keywords:["kitchen","cookware","utensils"],category:{tier1:"Home",tier2:"Kitchen & Dining"}},{keywords:["sheets","bed sheets","bedding"],category:{tier1:"Home",tier2:"Bedding",tier3:"Sheets"}},{keywords:["comforter","duvet"],category:{tier1:"Home",tier2:"Bedding"}},{keywords:["candle","candle holder"],category:{tier1:"Home",tier2:"Home Decor",tier3:"Candles & Holders"}},{keywords:["home decor","decor","pillow","throw","vase"],category:{tier1:"Home",tier2:"Home Decor"}},{keywords:["chair","table","furniture"],category:{tier1:"Home",tier2:"Furniture",tier3:"Chairs"}},{keywords:["bath","bathroom"],category:{tier1:"Home",tier2:"Bath"}},{keywords:["home"],category:{tier1:"Home",tier2:"Other"}},{keywords:["exercise","fitness equipment","weights","dumbbells"],category:{tier1:"Sports & Outdoors",tier2:"Exercise & Fitness"}},{keywords:["camping","hiking","outdoor gear"],category:{tier1:"Sports & Outdoors",tier2:"Outdoor Recreation"}},{keywords:["bicycle","bike","cycling"],category:{tier1:"Sports & Outdoors",tier2:"Cycling"}},{keywords:["sports","athletic equipment"],category:{tier1:"Sports & Outdoors",tier2:"Athletic Equipment"}},{keywords:["vintage toy","retro toy","antique toy"],category:{tier1:"Vintage & Collectibles",tier2:"Vintage Toys"}},{keywords:["collectible","memorabilia","antique"],category:{tier1:"Vintage & Collectibles",tier2:"Collectibles"}},{keywords:["vintage","retro"],category:{tier1:"Vintage & Collectibles",tier2:"Other"}},{keywords:["handmade jewelry","handcrafted jewelry"],category:{tier1:"Handmade",tier2:"Jewelry"}},{keywords:["handmade","handcrafted","diy","craft"],category:{tier1:"Handmade",tier2:"Other"}},{keywords:["office","desk","supplies","stationery"],category:{tier1:"Office",tier2:"Other"}},{keywords:["dog","puppy","cat","kitten","pet"],category:{tier1:"Pet Supplies",tier2:"Other"}}];function n(e){const t=[e.tier1,e.tier2];return e.tier3&&t.push(e.tier3),t.join("/")}function a(){return document.hidden}function s(e,t,i=!1){if(a()){const e=i?10:0;return 0===e?Promise.resolve():new Promise(t=>setTimeout(t,e))}{const i=Math.floor(Math.random()*(t-e+1))+e;return new Promise(e=>setTimeout(e,i))}}function c(e){return new Promise(t=>setTimeout(t,e))}const l=new class{delay(e,t){return s(e,t)}async typeText(e,t){if(e.focus(),e.value="",a())e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),await s(10,20,!0);else{for(const i of t)e.value+=i,e.dispatchEvent(new Event("input",{bubbles:!0})),await this.delay(50,150);e.dispatchEvent(new Event("change",{bubbles:!0}))}e.blur()}async clickElement(e){await this.delay(500,2e3),e.scrollIntoView({behavior:a()?"auto":"smooth",block:"center"}),await this.delay(200,500),e.click()}async waitForElement(e,t=1e4){return document.querySelector(e)||new Promise((i,o)=>{const r=setTimeout(()=>{n.disconnect(),o(new Error(`Element not found: ${e}`))},t),n=new MutationObserver(()=>{const t=document.querySelector(e);t&&(clearTimeout(r),n.disconnect(),i(t))});n.observe(document.body,{childList:!0,subtree:!0})})}async checkLoginStatus(){try{if(window.location.href.includes("/login")||window.location.href.includes("/signup"))return o("Redirected to login page - user is not logged in"),!1;const e=document.querySelector('a[href*="/login"]'),r=document.querySelector('a[href*="/signup"]');return e||r?(o("Login/signup buttons found - user is not logged in"),!1):document.querySelector('[data-testid="UserMenu"]')||document.querySelector('[data-testid="AccountButton"]')||document.querySelector('button[aria-label*="account" i]')||document.querySelector('button[aria-label*="profile" i]')?(t("User menu found - user is logged in"),!0):window.location.pathname.includes("/sell")?(t("On /sell page without login prompts - assuming logged in"),!0):(i("Could not definitively determine login status - proceeding cautiously"),!0)}catch(e){return o("Error checking login status:",e),!0}}async downloadImage(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to download image: ${t.statusText}`);return await t.blob()}async uploadImages(r){if(!r||0===r.length)return void i("No photo URLs provided, skipping image upload");t(`Uploading ${r.length} images to Mercari`,r);const n=r.slice(0,12);let a=0;await this.waitForElement('[data-testid="PhotoUploadBox"]'),t("Found photo upload box");for(let i=0;i<n.length;i++){e((n.length,n[i]));try{const e=document.querySelector('input[type="file"][accept*="image"]');if(!e)throw new Error("Could not find file input");t("Found file input:",e),t(`Downloading image from: ${n[i]}`);const o=await this.downloadImage(n[i]);t(`Downloaded blob: size=${o.size}, type=${o.type}`);const r=`image-${i+1}.jpg`,s=new File([o],r,{type:o.type||"image/jpeg"});t(`Created file: name=${s.name}, size=${s.size}, type=${s.type}`);const l=new DataTransfer;l.items.add(s),t(`DataTransfer files: ${l.files.length}`),e.files=l.files;const d=["input","change"];for(const t of d)e.dispatchEvent(new Event(t,{bubbles:!0}));t(`Triggered events for image ${i+1}, waiting for upload...`),await c(2500),a++,t(`Successfully uploaded image ${i+1}/${n.length}`)}catch(e){o(`Failed to upload image ${i+1}:`,e)}}if(0===a)throw new Error("Failed to upload any images");t(`${a}/${n.length} images uploaded successfully`)}async fillTitle(e){const t=await this.waitForElement('input[data-testid="Title"]');await this.typeText(t,e)}async fillDescription(e){const t=await this.waitForElement('textarea[data-testid="Description"]');await this.typeText(t,e)}async selectCategory(e,r,a){t("Selecting Mercari category:",n(e));try{const o=await this.waitForElement("button.CategorySection__SelectButton-sc-d0fb8a6d-0",5e3);await this.clickElement(o),await this.waitForElement(".CategoryDialog__ButtonWrapper-sc-13509435-1",5e3),await c(200);const r=document.querySelectorAll(".CategoryDialog__ButtonWrapper-sc-13509435-1");if(r.length>0){t(`Found ${r.length} tier 1 (main) category options`);let o=null;for(const t of Array.from(r))if((t.textContent?.trim()||"").toLowerCase()===e.tier1.toLowerCase()){o=t;break}if(!o)for(const t of Array.from(r))if((t.textContent?.toLowerCase()||"").includes(e.tier1.toLowerCase())){o=t;break}if(!o){i(`Tier 1 category "${e.tier1}" not found, using Women as default`);for(const e of Array.from(r))if((e.textContent?.toLowerCase()||"").includes("women")){o=e;break}}if(!o)throw new Error("Could not find any tier 1 category");{t(`Selecting tier 1: ${o.textContent?.trim()}`);const e=document.querySelectorAll(".CategoryDialog__ButtonWrapper-sc-13509435-1").length;await this.clickElement(o),await c(500);const i=5e3,r=Date.now();for(;Date.now()-r<i;){const i=document.querySelectorAll(".CategoryDialog__ButtonWrapper-sc-13509435-1").length;if(i!==e&&i>0){t("Tier 2 buttons loaded");break}await c(100)}}}const n=document.querySelectorAll(".CategoryDialog__ButtonWrapper-sc-13509435-1");if(n.length>0){t(`Found ${n.length} tier 2 (subcategory) options`);let o=null;for(const t of Array.from(n))if((t.textContent?.trim()||"").toLowerCase()===e.tier2.toLowerCase()){o=t;break}if(!o)for(const t of Array.from(n))if((t.textContent?.toLowerCase()||"").includes(e.tier2.toLowerCase())){o=t;break}if(!o){i(`Tier 2 category "${e.tier2}" not found, looking for "Other"`);for(const e of Array.from(n))if("other"===(e.textContent?.toLowerCase().trim()||"")){o=e;break}o||(o=n[n.length-1])}if(o){const i=o.textContent?.trim();t(`Selecting tier 2: ${i}`);const r=document.querySelectorAll(".CategoryDialog__ButtonWrapper-sc-13509435-1").length;await this.clickElement(o),await c(500);const n=5e3,a=Date.now();for(;Date.now()-a<n;){const e=document.querySelectorAll(".CategoryDialog__ButtonWrapper-sc-13509435-1").length;if(e!==r&&e>0){t("Tier 3 buttons loaded");break}await c(100)}if("other"===i?.toLowerCase()&&!e.tier3){t('Selected "Other" subcategory, looking for "All Other" tier 3...');const e=document.querySelectorAll(".CategoryDialog__ButtonWrapper-sc-13509435-1");if(e.length>0)for(const i of Array.from(e))if("all other"===(i.textContent?.toLowerCase().trim()||""))return t('Found "All Other" tier 3, selecting it'),await this.clickElement(i),await c(1e3),void t("Category selection completed")}}}if(e.tier3){const o=document.querySelectorAll(".CategoryDialog__ButtonWrapper-sc-13509435-1");if(o.length>0){t(`Found ${o.length} tier 3 (sub-subcategory) options`);let r=null;for(const t of Array.from(o))if((t.textContent?.trim()||"").toLowerCase()===e.tier3.toLowerCase()){r=t;break}if(!r)for(const t of Array.from(o))if((t.textContent?.toLowerCase()||"").includes(e.tier3.toLowerCase())){r=t;break}r?(t(`Selecting tier 3: ${r.textContent?.trim()}`),await this.clickElement(r),await c(1e3)):i(`Tier 3 category "${e.tier3}" not found, skipping`)}}await c(1e3),t("Category selection completed")}catch(e){o("Failed to select category:",e)}}async fillBrand(e){try{const o=await this.waitForElement('input[data-testid="Brand"]'),r=e&&"n/a"!==e.toLowerCase()&&"none"!==e.toLowerCase()?e:"No brand";t(`Selecting brand: "${r}"`),t(`Is background tab: ${a()}`),o.scrollIntoView({behavior:"auto",block:"center"}),await c(100),o.focus(),await c(200),t("Attempting to open brand dropdown...");const n=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0});o.dispatchEvent(n),await c(50);const s=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0});o.dispatchEvent(s),await c(50),o.click(),await c(50),o.focus(),o.click(),await c(1e3),t("Waiting for brand dropdown options with MutationObserver...");const l=await new Promise(e=>{let i;const o=setTimeout(()=>{i?.disconnect(),e(!1)},1e4);i=new MutationObserver(()=>{const r=document.querySelectorAll('[role="option"]');r.length>0&&(t(`MutationObserver detected ${r.length} brand options`),clearTimeout(o),i.disconnect(),e(!0))}),i.observe(document.body,{childList:!0,subtree:!0});const r=document.querySelectorAll('[role="option"]');r.length>0&&(t(`Found ${r.length} brand options immediately`),clearTimeout(o),i.disconnect(),e(!0))});if(!l)throw new Error("Brand dropdown options did not appear after 10 seconds");const d=Array.from(document.querySelectorAll('[role="option"]'));t(`Found ${d.length} brand options`);let u=null;const g=r.toLowerCase();for(const e of d){const i=e.textContent?.trim().toLowerCase()||"";if(t(`Checking option: "${e.textContent?.trim()}"`),"no brand"===g&&(i.includes("no brand")||i.includes("not sure"))){u=e,t(`Matched "No brand" option: "${e.textContent?.trim()}"`);break}if(i.includes(g)){u=e,t(`Matched brand option: "${e.textContent?.trim()}"`);break}}u||(u=d[0],i(`No match found for "${r}", using first option: "${u.textContent?.trim()}"`));const y=u;y.scrollIntoView({behavior:"auto",block:"nearest"}),await c(100),y.click(),await c(500);const h=o.value;if(t(`Brand selected! Final value: "${h}"`),!h)throw new Error("Brand option clicked but value not set");t("Brand selection completed successfully")}catch(e){throw i("Failed to fill brand:",e),e}}async selectCondition(e){try{const i={new:"ConditionNew",like_new:"ConditionLikeNew",good:"ConditionGood",fair:"ConditionFair",poor:"ConditionPoor"}[e]||"ConditionGood",o=await this.waitForElement(`label[data-testid="${i}"]`);await this.clickElement(o),await this.delay(500,1e3),t(`Selected condition: ${i}`)}catch(e){throw i("Failed to select condition:",e),e}}async selectSize(e){try{t("Looking for size dropdown...");const o=await this.waitForElement('[data-testid="Size"]',5e3);t("Size field found! Selecting size..."),o.scrollIntoView({behavior:"smooth",block:"center"}),await this.delay(500,1e3),t("Clicking size dropdown..."),await this.clickElement(o),await this.delay(1e3,1500);const r=document.querySelectorAll('[data-testid="Size-option"]');if(r.length>0){if(t(`Found ${r.length} size options`),!e||"n/a"===e.toLowerCase()||"none"===e.toLowerCase()){for(const e of Array.from(r))if(e.textContent?.includes("One Size"))return void await this.clickElement(e);return void await this.clickElement(r[0])}const o=e.toUpperCase();for(const t of Array.from(r)){const i=t.textContent||"";if(i.includes(o)||i.includes(e)||o.length<=3&&i.startsWith(o))return void await this.clickElement(t)}i(`Size "${e}" not found, selecting first option`),await this.clickElement(r[0])}}catch(e){t("Size field not found - skipping (not required for this category)")}}async selectShipping(e,i,r,n){t("Selecting shipping:",{weightLb:e,weightOz:i,preferredCarrier:r,preferredType:n});try{const o=await this.waitForElement('input[data-testid="SelectShipping"]');t("Found shipping input, clicking to open dialog..."),await this.clickElement(o),await this.delay(1e3,2e3);const a=await this.waitForElement('input[data-testid="ItemWeightInPounds"]');if(t("Found pounds input, entering weight:",e),a.value="",a.focus(),await this.delay(100,200),await this.typeText(a,e.toString()),await this.delay(500,1e3),i>0){const e=await this.waitForElement('input[data-testid="ItemWeightInOunces"]');t("Found ounces input, entering weight:",i),await this.typeText(e,i.toString()),await this.delay(500,1e3)}try{if(await this.waitForElement('div[data-testid="WillItemFitInShoebox"]',3e3),t("Found shoebox question, answering..."),e+i/16<=5){const e=await this.waitForElement('input[data-testid="FitsInShoeboxYes"]');t('Selecting "Yes" - fits in shoebox'),await this.clickElement(e)}else{const e=await this.waitForElement('input[data-testid="FitsInShoeboxNo"]');t('Selecting "No" - does not fit in shoebox'),await this.clickElement(e)}await this.delay(500,1e3)}catch(e){t("No shoebox question found, continuing...")}const s=await this.waitForElement('button[data-testid="SelectCarrierButton"]');t("Clicking Next to view carrier options..."),await this.clickElement(s),await this.delay(2e3,3e3);const c=await this.waitForElement('div[data-testid="shipping-choices"]');t("Shipping options loaded");const l=c.querySelectorAll('div[data-role="shipping-choice"]');if(t(`Found ${l.length} shipping options`),0===l.length)throw new Error("No shipping options available");let d=null;if(r&&"cheapest"!==r&&n&&"auto"!==n){t("Looking for preferred carrier:",r,"type:",n);const e={usps:"shippo_usps",ups:"ups",fedex:"fedex"}[r]||r,i={ground_advantage:"standard",priority:"standard",media_mail:"media_mail",surepost:"surepost",ground:"standard",smartpost:"smartpost",home:"standard"}[n]||"standard";for(const o of Array.from(l)){const r=o.getAttribute("data-carrier"),a=o.getAttribute("data-handling-type"),s=o.getAttribute("data-display-name")||"";if(r===e&&a===i){t("Found matching preferred option:",s),d=o;break}if("priority"===n&&s.includes("Priority Mail")){t("Found Priority Mail option:",s),d=o;break}}}if(!d){t("Finding cheapest shipping option...");let e=1/0;for(const t of Array.from(l)){const i=t.querySelector('h5[color="black"]');if(!i)continue;const o=(i.textContent||"").match(/\$(\d+\.\d+)/);if(o){const i=parseFloat(o[1]);i<e&&(e=i,d=t)}}if(d){const i=d.getAttribute("data-display-name");t("Selected cheapest option:",i,`($${e.toFixed(2)})`)}}d||(d=l[0],t("Using fallback: selecting first option"));const u=d.querySelector('input[type="radio"]');if(!u)throw new Error("Could not find radio button for shipping option");t("Clicking radio button to select shipping option..."),await this.clickElement(u),await this.delay(1e3,2e3),t("Shipping option selected");const g=await this.waitForElement('button[data-testid="SelectCarrierSaveButton"]');t("Clicking Save to confirm shipping selection..."),await this.clickElement(g),await this.delay(1e3,2e3),t("Shipping selection saved successfully")}catch(e){throw o("Failed to select shipping:",e),e}}async fillPrice(e,o){try{const r=await this.waitForElement('input[data-testid="Price"]');if(r.focus(),await this.delay(100,200),r.value=String(Math.ceil(e)),r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(300,500),r.blur(),await this.delay(1e3,1500),o&&o>0){t("Setting floor price for smart pricing:",o);const e=await this.waitForElement('input[data-testid="SmartPricingFloorPrice"]');e.focus(),await this.delay(100,200),e.value=String(Math.ceil(o)),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),await this.delay(200,300),e.blur()}else{t("Turning off smart pricing");try{if(document.querySelector('button[data-testid="SmartPricingButton"][aria-pressed="true"]')){const e=await this.waitForElement('button[data-testid="SmartPricingTurnOffButton"]',3e3);await this.clickElement(e),await this.delay(500,1e3)}}catch(e){i("Could not turn off smart pricing:",e)}}t("Price set to:",e)}catch(e){throw i("Failed to fill price:",e),e}}async submitListing(){try{const e=await this.waitForElement('button[data-testid="ListButton"]',1e4);t("Found List button");const r=e.disabled;if(t("List button disabled state:",r),r){t("List button is disabled, waiting for it to be enabled...");let i=0;for(;e.disabled&&i<10;)await this.delay(500,1e3),i++;if(e.disabled)throw new Error("List button remained disabled after waiting");t("List button is now enabled")}e.scrollIntoView({behavior:"smooth",block:"center"}),await this.delay(500,1e3),t("Clicking List button to submit listing...");let n=!1;for(let o=1;o<=3;o++)try{t(`Click attempt ${o}/3`),await this.clickElement(e),n=!0,t("Successfully clicked List button");break}catch(e){i(`Click attempt ${o} failed:`,e),o<3&&await this.delay(1e3,2e3)}if(!n)throw new Error("Failed to click List button after 3 attempts");t("Waiting for page navigation after submission...");const a=15e3,s=Date.now();let l=window.location.href;for(;Date.now()-s<a;){if(l=window.location.href,l.includes("/item/")||l.includes("/mypage/listings")){t("Navigation detected - listing submitted successfully");break}const e=document.querySelectorAll('[class*="error" i], [class*="Error" i], [role="alert"]');if(e.length>0){const t=Array.from(e).map(e=>e.textContent).join(", ");throw o("Error message detected on page:",t),new Error(`Mercari submission error: ${t}`)}await c(500)}if(t("Current URL after submission:",l),l.includes("/item/")||l.includes("/mypage/listings")){t("Listing submitted successfully - redirected to success page");const e=l.match(/\/item\/m(\d+)/);return{platformListingId:e?e[1]:"success",platformUrl:l}}o("Still on /sell page after 15 seconds - listing may not have submitted");const d=document.querySelectorAll('[class*="error" i], [class*="Error" i], [role="alert"]');if(d.length>0){const e=Array.from(d).map(e=>e.textContent).join(", ");throw new Error(`Mercari submission failed: ${e}`)}throw new Error("Listing submission failed - page did not navigate after clicking List button. Please check Mercari manually.")}catch(e){throw o("Failed to submit listing:",e),e}}async createListing(e){try{if(t("Starting Mercari listing creation for:",e.title),t("Listing data received:",JSON.stringify(e)),t("Photo URLs:",e.photo_urls),t("Checking Mercari login status..."),!await this.checkLoginStatus())throw new Error("Not logged in to Mercari. Please log in at mercari.com and try again.");let o;t("Login check passed - proceeding with listing creation"),await this.uploadImages(e.photo_urls),await this.fillTitle(e.title),await this.fillDescription(e.description),e.mercari_category?(t("Using pre-determined Mercari category:",e.mercari_category),o=function(e){const t=e.split("/").map(e=>e.trim());return{tier1:t[0]||"Women",tier2:t[1]||"Other",tier3:t[2]}}(e.mercari_category)):(t("Auto-detecting Mercari category from listing data"),o=function(e,t="",i=""){const o=`${e} ${t} ${i}`.toLowerCase();for(const e of r)for(const t of e.keywords)if(o.includes(t.toLowerCase()))return e.category;return{tier1:"Women",tier2:"Other",tier3:"All Other"}}(e.title,e.description,e.category||""),t("Suggested category:",n(o))),await this.selectCategory(o,e.title,e.description),await this.fillBrand(e.brand),await this.selectCondition(e.condition),await this.selectSize(e.size);const a=e.weight_lb||0,s=e.weight_oz||0;0===a&&0===s&&i("No weight specified, using default 1 lb"),await this.selectShipping(a||1,s||0,e.mercari_shipping_carrier||"cheapest",e.mercari_shipping_type||"auto");const c=e.original_price&&e.original_price<e.price?e.original_price:void 0;await this.fillPrice(e.price,c),t("Waiting for form to be ready for submission..."),await this.delay(2e3,3e3);const l=await this.submitListing();return{success:!0,listingId:e.id,platform:"mercari",platformListingId:l.platformListingId,platformUrl:l.platformUrl}}catch(t){return o("Failed to create Mercari listing:",t),{success:!1,listingId:e.id,platform:"mercari",error:t instanceof Error?t.message:"Unknown error"}}}};window.addEventListener("message",e=>{if((e.origin.includes("compr.co")||e.origin===window.location.origin)&&"CREATE_LISTING"===e.data.type){t("Received CREATE_LISTING from parent window (iframe mode)");const{listingData:i}=e.data;l.createListing(i).then(e=>{window.parent.postMessage({type:"LISTING_RESULT",result:e},"*")}).catch(e=>{window.parent.postMessage({type:"LISTING_ERROR",error:e.message},"*")})}}),chrome.runtime.onMessage.addListener((e,i,r)=>{if(e.type,"CREATE_LISTING"===e.type){const{listingData:t}=e.payload;return l.createListing(t).then(e=>{r(e)}).catch(e=>{r({success:!1,listingId:t.id,platform:"mercari",error:e.message})}),!0}if("CHECK_LOGIN"===e.type){const e=function(){console.log("[Mercari] Checking login status...");const e=window.location.pathname.toLowerCase();if(e.includes("/login")||e.includes("/signup")||e.includes("/register"))return console.log("[Mercari] On login page - NOT logged in"),!1;if(document.querySelector('[data-testid="LoginButton"]'))return console.log("[Mercari] Found login button - NOT logged in"),!1;if(document.querySelector('[data-testid="LogoutMenuItem"]'))return console.log("[Mercari] Found logout button - logged in"),!0;if(e.includes("/mypage")||e.includes("/dashboard"))return console.log("[Mercari] On authenticated path - logged in"),!0;if(document.querySelector('a[href*="/mypage/"]'))return console.log("[Mercari] Found mypage link - logged in"),!0;if(document.querySelector('a[href*="/selling/dashboard"]'))return console.log("[Mercari] Found seller dashboard link - logged in"),!0;const t=document.querySelector('a[href*="/mypage/purchase"]'),i=document.querySelector('a[href*="/mypage/listings"]');if(t||i)return console.log("[Mercari] Found account links - logged in"),!0;const o=document.querySelector('header a[href*="/login"], nav a[href*="/login"], [data-testid="login-button"]'),r=document.querySelector('header a[href*="/signup"], nav a[href*="/signup"], [data-testid="signup-button"]'),n=Array.from(document.querySelectorAll("header button, header a, nav button, nav a")),a=n.some(e=>{const t=e.textContent?.toLowerCase()||"";return t.includes("log in")||t.includes("login")||t.includes("sign in")}),s=n.some(e=>{const t=e.textContent?.toLowerCase()||"";return t.includes("sign up")||t.includes("signup")}),c=document.querySelector('form[action*="login"], input[type="email"][name*="email"]'),l=document.querySelector('input[type="password"]');return o||r||a||s||c&&l?(console.log("[Mercari] Found login indicators in header - NOT logged in"),!1):(console.log("[Mercari] No clear indicators - NOT logged in"),!1)}();return t("Mercari login status:",e),r({loggedIn:e}),!0}if("GET_MERCARI_AUTH"===e.type){t("Extracting Mercari auth tokens from page context");try{let e=null,i=null;const o=Object.keys(localStorage);for(const i of o){const o=localStorage.getItem(i);if(o){if(o.startsWith("eyJ")&&o.includes(".")){e=o,t(`Found potential JWT in localStorage key: ${i}`);break}try{const r=JSON.parse(o);if(r.token||r.accessToken||r.jwt){e=r.token||r.accessToken||r.jwt,t(`Found token in parsed localStorage key: ${i}`);break}}catch(e){}}}if(!e){const i=Object.keys(sessionStorage);for(const o of i){const i=sessionStorage.getItem(o);if(i&&i.startsWith("eyJ")&&i.includes(".")){e=i,t(`Found potential JWT in sessionStorage key: ${o}`);break}}}const n=document.querySelector('meta[name="csrf-token"]');if(n&&(i=n.content,t("Found CSRF token in meta tag")),!i){const e=["csrf","csrfToken","csrf_token","xsrf"];for(const o of e){const e=localStorage.getItem(o);if(e){i=e,t(`Found CSRF token in localStorage key: ${o}`);break}}}t("Auth extraction result:",{hasBearerToken:!!e,hasCsrfToken:!!i}),r({bearerToken:e,csrfToken:i})}catch(e){o("Failed to extract Mercari auth:",e),r({bearerToken:null,csrfToken:null})}return!0}if("DELETE_LISTING"===e.type){const{platformListingId:i,reason:n}=e.payload;return t("Deleting Mercari listing:",i,"reason:",n),async function(e){t(`[Mercari] Deleting listing ${e}`);try{await l.delay(2e3,3e3);const e=await l.waitForElement('[data-testid="DeleteButton"]',1e4);t("[Mercari] Found delete button, clicking..."),await l.clickElement(e),await l.delay(1e3,2e3);const i=Array.from(document.querySelectorAll("button")).find(e=>{const t=e.textContent?.toLowerCase()||"";return t.includes("delete")||t.includes("confirm")||t.includes("yes")});i&&(t("[Mercari] Found confirmation button, clicking..."),await l.clickElement(i),await l.delay(2e3,3e3)),t("[Mercari] Listing deleted successfully")}catch(e){throw o("[Mercari] Failed to delete listing:",e),new Error(`Failed to delete listing: ${e instanceof Error?e.message:"Unknown error"}`)}}(i).then(()=>{r({success:!0,platformListingId:i})}).catch(e=>{r({success:!1,platformListingId:i,error:e.message})}),!0}}),t("Mercari content script loaded")})();