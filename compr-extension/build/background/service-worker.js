(()=>{"use strict";var e={d:(t,o)=>{for(var s in o)e.o(o,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:o[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{B:()=>u});const t={poshmark:{base:"https://poshmark.com",login:"https://poshmark.com/login",createListing:"https://poshmark.com/create-listing",mySales:"https://poshmark.com/sales"},mercari:{base:"https://www.mercari.com",login:"https://www.mercari.com/login",createListing:"https://www.mercari.com/sell"},depop:{base:"https://www.depop.com",login:"https://www.depop.com/login",createListing:"https://www.depop.com/products/create"}},o="saleDetectionAlarm",s="userId",n="authToken",a="settings",i="lastSaleCheck";function r(e,t,o){return{type:e,payload:t,requestId:o||`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now()}}async function c(e,t){return new Promise((o,s)=>{chrome.tabs.sendMessage(e,t,e=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):o(e)})})}const l={debug:(...e)=>{},info:(...e)=>{console.info("[Compr Extension]",...e)},warn:(...e)=>{console.warn("[Compr Extension]",...e)},error:(...e)=>{console.error("[Compr Extension]",...e)}},h=new class{constructor(){this.userId=null,this.authToken=null,this.pollingInterval=null,this.isPolling=!1;const e=chrome.runtime.getManifest().version.includes("dev")||"1.0.0"===chrome.runtime.getManifest().version;this.baseUrl=e?"http://localhost:3000":"https://compr.co"}async loadSettings(){const e=await chrome.storage.local.get([s,n]);this.userId=e[s]||null,this.authToken=e[n]||null,l.debug("HTTP client settings loaded",{hasUserId:!!this.userId,hasAuthToken:!!this.authToken})}async updateAuth(e,t){this.userId=e,this.authToken=t,await chrome.storage.local.set({[s]:e,[n]:t}),await this.connect()}async connect(){if(this.userId&&this.authToken||await this.loadSettings(),this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/connect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,platformStatuses:[]})});if(!e.ok)throw new Error(`Connect failed: ${e.statusText}`);const t=await e.json();if(l.info("Connected to backend:",t),t.pendingJobs&&t.pendingJobs.length>0)for(const e of t.pendingJobs)await this.handleCreateListing(e);this.startPolling()}catch(e){l.error("Failed to connect to backend:",e)}else l.warn("Cannot connect: missing userId or authToken")}startPolling(){this.isPolling?l.debug("Already polling"):(this.isPolling=!0,l.info("Starting job polling"),this.pollingInterval=setInterval(()=>{this.poll()},5e3))}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isPolling=!1,l.info("Stopped polling")}async poll(){if(this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/poll?userId=${this.userId}&authToken=${this.authToken}`);if(!e.ok)return void l.warn("Poll failed:",e.statusText);const t=await e.json();if(t.hasNewJobs&&t.jobs){l.info(`Found ${t.jobs.length} new jobs`);for(const e of t.jobs)await this.handleCreateListing(e)}}catch(e){l.error("Polling error:",e)}}async handleCreateListing(e){const{jobId:t,platform:o,listingData:s}=e;l.info(`Processing job ${t}: Create listing on ${o}`),await u({type:"CREATE_LISTING",payload:{platform:o,listingData:s,userId:this.userId},requestId:t,timestamp:Date.now()})}async markJobInProgress(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/job-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,jobId:e,status:"processing"})});if(!t.ok)throw new Error(`Failed to mark job in progress: ${t.statusText}`);l.info("Job marked as in_progress:",e)}catch(e){throw l.error("Failed to mark job in progress:",e),e}else l.warn("Cannot mark job in progress: missing credentials")}async sendResult(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/callback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,result:e})});if(!t.ok)throw new Error(`Callback failed: ${t.statusText}`);l.info("Result sent successfully")}catch(e){l.error("Failed to send result:",e)}else l.warn("Cannot send result: missing credentials")}get connected(){return this.isPolling&&!!this.userId&&!!this.authToken}},d=new class{constructor(){this.isRunning=!1}async initialize(){l.info("Initializing sale detection framework");const e=(await chrome.storage.local.get(a))[a]||{};if(!e.autoDelete)return void l.info("Auto-delete is disabled, skipping sale detection setup");const t=e.checkInterval||10;await chrome.alarms.create(o,{periodInMinutes:t,delayInMinutes:t}),l.info(`Sale detection alarm created (every ${t} minutes)`)}async startCheck(){if(this.isRunning)l.warn("Sale detection already running");else{this.isRunning=!0,l.info("Starting sale detection check");try{const e=await this.checkPoshmarkSales(),t=await this.checkMercariSales(),o=await this.checkDepopSales(),s=[...e,...t,...o];s.length>0?(l.info(`Found ${s.length} sold items`,s),await this.processSoldItems(s)):l.debug("No sold items found"),await chrome.storage.local.set({[i]:Date.now()})}catch(e){l.error("Error during sale detection check:",e)}finally{this.isRunning=!1}}}async checkPoshmarkSales(){return l.debug("Checking Poshmark for sales (not implemented)"),[]}async checkMercariSales(){return l.debug("Checking Mercari for sales (not implemented)"),[]}async checkDepopSales(){return l.debug("Checking Depop for sales (not implemented)"),[]}async processSoldItems(e){l.info("Processing sold items:",e);for(const t of e)await this.showSaleNotification(t)}async showSaleNotification(e){((await chrome.storage.local.get(a))[a]||{}).notifications&&await chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"Item Sold!",message:`Your item sold on ${e.platform}. Auto-delisting from other platforms...`,priority:2})}async manualCheck(){l.info("Manual sale detection check triggered"),await this.startCheck()}async stop(){await chrome.alarms.clear(o),l.info("Sale detection stopped")}};async function u(e){l.info("Handling WebSocket message:",e.type);try{switch(e.type){case"CREATE_LISTING":await async function(e,o){const{platform:s,listingData:n,userId:a}=e;l.info(`Creating listing on ${s}:`,n.title);try{await h.markJobInProgress(o)}catch(e){l.warn("Failed to mark job as in_progress:",e)}await async function(e,t){l.debug("Progress update:",{listingId:e,platform:t,status:"uploading_images",progress:0})}(n.id,s);try{const e=t[s]?.createListing;if(!e)throw new Error(`Unknown platform: ${s}`);const o=await chrome.tabs.create({url:e,active:!1});if(!o.id)throw new Error("Failed to create tab");await g(o.id);const a=r("CREATE_LISTING",{listingData:n}),i=await c(o.id,a);await h.sendResult({success:!0,listingId:n.id,platform:s,platformListingId:i.platformListingId,platformUrl:i.platformUrl}),setTimeout(()=>{o.id&&chrome.tabs.remove(o.id)},2e3),l.info("Listing created successfully:",i)}catch(e){throw l.error("Failed to create listing:",e),await h.sendResult({success:!1,listingId:n.id,platform:s,error:e instanceof Error?e.message:"Unknown error"}),e}}(e.payload,e.requestId);break;case"DELETE_LISTING":await async function(e){const{platform:t,platformListingId:o,reason:s}=e;l.info(`Deleting listing ${o} on ${t} (reason: ${s})`),l.warn("Delete listing not yet implemented")}(e.payload);break;case"CHECK_STATUS":await async function(){await Promise.all(["poshmark","mercari","depop"].map(e=>m(e)))}();break;default:l.warn("Unhandled WebSocket message type:",e.type)}}catch(e){l.error("Error handling message:",e)}}async function m(e){return{platform:e,loggedIn:!1,lastChecked:Date.now()}}function g(e){return new Promise((t,o)=>{const s=setTimeout(()=>{o(new Error("Tab load timeout"))},3e4);chrome.tabs.onUpdated.addListener(function o(n,a){n===e&&"complete"===a.status&&(clearTimeout(s),chrome.tabs.onUpdated.removeListener(o),setTimeout(t,8e3))})})}chrome.runtime.onInstalled.addListener(async e=>{l.info("Extension installed/updated:",e.reason),"install"===e.reason&&(await chrome.storage.local.set({settings:{autoDelete:!0,checkInterval:10,notifications:!0},platformConnections:[]}),await chrome.tabs.create({url:"https://compr.co/extension-installed"})),await d.initialize()}),chrome.runtime.onStartup.addListener(async()=>{l.info("Extension started"),await h.connect(),await d.initialize()}),chrome.alarms.onAlarm.addListener(async e=>{e.name===o&&(l.info("Sale detection alarm triggered"),await d.startCheck())}),chrome.runtime.onMessage.addListener((e,t,o)=>{switch(l.debug("Received message:",e.type,e),e.type){case"WS_MESSAGE_RECEIVED":return u(e.message).then(()=>o({success:!0})).catch(e=>o({success:!1,error:e.message})),!0;case"CONNECTION_STATUS":o({connected:h.connected});break;case"CONNECT_BACKEND":return async function(e){const{userId:t,authToken:o}=e;if(!t||!o)throw new Error("Missing userId or authToken");await h.updateAuth(t,o),l.info("Backend connection updated with new credentials")}(e.payload).then(()=>o({success:!0})).catch(e=>o({success:!1,error:e.message})),!0;case"VERIFY_SESSION":return async function(e){const{platform:t}=e;l.info(`Verifying session for ${t}`);try{const e=await async function(e){try{const t={poshmark:".poshmark.com",mercari:".mercari.com",depop:".depop.com"}[e],o=await chrome.cookies.getAll({domain:t}),s=["session","sess","auth","token","jwt","_session","user_session","auth_token","PHPSESSID","connect.sid","__Secure-"],n=o.some(e=>s.some(t=>e.name.toLowerCase().includes(t.toLowerCase())));return n&&o.length>2?{hasAuthCookies:!0,confidence:"high"}:n?{hasAuthCookies:!0,confidence:"medium"}:{hasAuthCookies:!1,confidence:"low"}}catch(e){return l.error("Cookie check error:",e),{hasAuthCookies:!1,confidence:"low"}}}(t);l.info(`Cookie check for ${t}:`,e);const o={poshmark:"https://poshmark.com",mercari:"https://www.mercari.com",depop:"https://www.depop.com"}[t];if(!o)throw new Error(`Unknown platform: ${t}`);const s=await chrome.tabs.query({url:`${o}/*`});let n;if(s.length>0&&s[0].id)n=s[0].id,l.info(`Using existing ${t} tab`);else{const e=await chrome.tabs.create({url:o,active:!1});if(!e.id)throw new Error("Failed to create tab");n=e.id,await g(n)}const a=r("CHECK_LOGIN",{});l.info(`Sending CHECK_LOGIN message to ${t} tab ${n}`);try{const o=await c(n,a);l.info(`${t} content script response:`,o),0===s.length&&setTimeout(()=>{l.info(`Closing ${t} verification tab ${n}`),chrome.tabs.remove(n)},1e4);const i=o.loggedIn,r=e.hasAuthCookies;let h,d;return l.info(`${t} verification results - DOM: ${i}, Cookies: ${r}`),i&&r&&"high"===e.confidence?(h="high",d=!0):i&&r?(h="medium",d=!0):(h="low",d=!1),d&&"low"!==h?(l.info(`Session verified for ${t} with ${h} confidence`),{success:!0,confidence:h}):(l.warn(`Not logged in to ${t} (confidence: ${h})`),{success:!1,error:`Not logged in to ${t}. Please log in and try again.`,confidence:h})}catch(e){return l.error(`${t} content script error:`,e),0===s.length&&setTimeout(()=>{chrome.tabs.remove(n)},2e3),{success:!1,error:"Extension verification failed. Please reload the extension at chrome://extensions and try again.",confidence:"low"}}}catch(e){return l.error("Session verification error:",e),{success:!1,error:`Verification error: ${e instanceof Error?e.message:"Unknown error during verification"}. Try reloading the extension.`,confidence:"low"}}}(e.payload).then(e=>o(e)).catch(e=>o({success:!1,error:e.message})),!0;case"MANUAL_SALE_CHECK":return d.manualCheck().then(()=>o({success:!0})).catch(e=>o({success:!1,error:e.message})),!0;case"GET_PLATFORM_STATUS":return m(e.payload.platform).then(e=>o(e)).catch(e=>o({error:e.message})),!0;default:l.warn("Unknown message type:",e.type)}}),setInterval(()=>{h.connected&&l.debug("Service worker keepalive")},2e4),h.connect(),l.info("Background service worker initialized")})();