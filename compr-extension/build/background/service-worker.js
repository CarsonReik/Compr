(()=>{"use strict";var e,t,r,o,a={},i={};function s(e){var t=i[e];if(void 0!==t)return t.exports;var r=i[e]={exports:{}};return a[e](r,r.exports,s),r.exports}s.m=a,t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,s.t=function(r,o){if(1&o&&(r=this(r)),8&o)return r;if("object"==typeof r&&r){if(4&o&&r.__esModule)return r;if(16&o&&"function"==typeof r.then)return r}var a=Object.create(null);s.r(a);var i={};e=e||[null,t({}),t([]),t(t)];for(var n=2&o&&r;("object"==typeof n||"function"==typeof n)&&!~e.indexOf(n);n=t(n))Object.getOwnPropertyNames(n).forEach(e=>i[e]=()=>r[e]);return i.default=()=>r,s.d(a,i),a},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.f={},s.e=e=>Promise.all(Object.keys(s.f).reduce((t,r)=>(s.f[r](e,t),t),[])),s.u=e=>e+".js",s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r={},o="compr-extension:",s.l=(e,t,a,i)=>{if(r[e])r[e].push(t);else{var n,c;if(void 0!==a)for(var l=document.getElementsByTagName("script"),d=0;d<l.length;d++){var h=l[d];if(h.getAttribute("src")==e||h.getAttribute("data-webpack")==o+a){n=h;break}}n||(c=!0,(n=document.createElement("script")).charset="utf-8",s.nc&&n.setAttribute("nonce",s.nc),n.setAttribute("data-webpack",o+a),n.src=e),r[e]=[t];var u=(t,o)=>{n.onerror=n.onload=null,clearTimeout(p);var a=r[e];if(delete r[e],n.parentNode&&n.parentNode.removeChild(n),a&&a.forEach(e=>e(o)),t)return t(o)},p=setTimeout(u.bind(null,void 0,{type:"timeout",target:n}),12e4);n.onerror=u.bind(null,n.onerror),n.onload=u.bind(null,n.onload),c&&document.head.appendChild(n)}},s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;s.g.importScripts&&(e=s.g.location+"");var t=s.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=e+"../"})(),(()=>{var e={458:0};s.f.j=(t,r)=>{var o=s.o(e,t)?e[t]:void 0;if(0!==o)if(o)r.push(o[2]);else{var a=new Promise((r,a)=>o=e[t]=[r,a]);r.push(o[2]=a);var i=s.p+s.u(t),n=new Error;s.l(i,r=>{if(s.o(e,t)&&(0!==(o=e[t])&&(e[t]=void 0),o)){var a=r&&("load"===r.type?"missing":r.type),i=r&&r.target&&r.target.src;n.message="Loading chunk "+t+" failed.\n("+a+": "+i+")",n.name="ChunkLoadError",n.type=a,n.request=i,o[1](n)}},"chunk-"+t,t)}};var t=(t,r)=>{var o,a,[i,n,c]=r,l=0;if(i.some(t=>0!==e[t])){for(o in n)s.o(n,o)&&(s.m[o]=n[o]);c&&c(s)}for(t&&t(r);l<i.length;l++)a=i[l],s.o(e,a)&&e[a]&&e[a][0](),e[a]=0},r=self.webpackChunkcompr_extension=self.webpackChunkcompr_extension||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})(),s.d({},{B:()=>v});const n={poshmark:{base:"https://poshmark.com",login:"https://poshmark.com/login",createListing:"https://poshmark.com/create-listing",mySales:"https://poshmark.com/sales"},mercari:{base:"https://www.mercari.com",login:"https://www.mercari.com/login",createListing:"https://www.mercari.com/sell"},depop:{base:"https://www.depop.com",login:"https://www.depop.com/login",createListing:"https://www.depop.com/products/create"}},c="saleDetectionAlarm",l="userId",d="authToken",h="settings",u="lastSaleCheck";function p(e,t,r){return{type:e,payload:t,requestId:r||`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now()}}async function m(e,t){return new Promise((r,o)=>{chrome.tabs.sendMessage(e,t,e=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):r(e)})})}const f={debug:(...e)=>{},info:(...e)=>{console.info("[Compr Extension]",...e)},warn:(...e)=>{console.warn("[Compr Extension]",...e)},error:(...e)=>{console.error("[Compr Extension]",...e)}},g=new class{constructor(){this.userId=null,this.authToken=null,this.pollingInterval=null,this.isPolling=!1;const e=chrome.runtime.getManifest().version.includes("dev")||"1.0.0"===chrome.runtime.getManifest().version;this.baseUrl=e?"http://localhost:3000":"https://compr.co"}async loadSettings(){const e=await chrome.storage.local.get([l,d]);this.userId=e[l]||null,this.authToken=e[d]||null,f.debug("HTTP client settings loaded",{hasUserId:!!this.userId,hasAuthToken:!!this.authToken})}async updateAuth(e,t){this.userId=e,this.authToken=t,await chrome.storage.local.set({[l]:e,[d]:t}),await this.connect()}async connect(){if(this.userId&&this.authToken||await this.loadSettings(),this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/connect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,platformStatuses:[]})});if(!e.ok)throw new Error(`Connect failed: ${e.statusText}`);const t=await e.json();if(f.info("Connected to backend:",t),t.pendingJobs&&t.pendingJobs.length>0)for(const e of t.pendingJobs)await this.handleCreateListing(e);this.startPolling()}catch(e){f.error("Failed to connect to backend:",e)}else f.warn("Cannot connect: missing userId or authToken")}startPolling(){this.isPolling?f.debug("Already polling"):(this.isPolling=!0,f.info("Starting job polling"),this.pollingInterval=setInterval(()=>{this.poll()},5e3))}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isPolling=!1,f.info("Stopped polling")}async poll(){if(this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/poll?userId=${this.userId}&authToken=${this.authToken}`);if(!e.ok)return void f.warn("Poll failed:",e.statusText);const t=await e.json();if(t.hasNewJobs&&t.jobs){f.info(`Found ${t.jobs.length} new jobs`);for(const e of t.jobs)"DELETE"===e.operation?await this.handleDeleteListing(e):await this.handleCreateListing(e)}}catch(e){f.error("Polling error:",e)}}async handleCreateListing(e){const{jobId:t,platform:r,listingData:o}=e;f.info(`Processing job ${t}: Create listing on ${r}`),await v({type:"CREATE_LISTING",payload:{platform:r,listingData:o,userId:this.userId},requestId:t,timestamp:Date.now()})}async handleDeleteListing(e){const{jobId:t,platform:r,platformListingId:o}=e;f.info(`Processing job ${t}: Delete listing ${o} from ${r}`),await v({type:"DELETE_LISTING",payload:{platform:r,platformListingId:o,reason:"user_requested"},requestId:t,timestamp:Date.now()})}async markJobInProgress(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/job-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,jobId:e,status:"processing"})});if(!t.ok)throw new Error(`Failed to mark job in progress: ${t.statusText}`);f.info("Job marked as in_progress:",e)}catch(e){throw f.error("Failed to mark job in progress:",e),e}else f.warn("Cannot mark job in progress: missing credentials")}async sendResult(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/callback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,result:e})});if(!t.ok)throw new Error(`Callback failed: ${t.statusText}`);f.info("Result sent successfully")}catch(e){f.error("Failed to send result:",e)}else f.warn("Cannot send result: missing credentials")}get connected(){return this.isPolling&&!!this.userId&&!!this.authToken}},w=new class{constructor(){this.isRunning=!1}async initialize(){f.info("Initializing sale detection framework");const e=(await chrome.storage.local.get(h))[h]||{};if(!e.autoDelete)return void f.info("Auto-delete is disabled, skipping sale detection setup");const t=e.checkInterval||10;await chrome.alarms.create(c,{periodInMinutes:t,delayInMinutes:t}),f.info(`Sale detection alarm created (every ${t} minutes)`)}async startCheck(){if(this.isRunning)f.warn("Sale detection already running");else{this.isRunning=!0,f.info("Starting sale detection check");try{const e=await this.checkPoshmarkSales(),t=await this.checkMercariSales(),r=await this.checkDepopSales(),o=[...e,...t,...r];o.length>0?(f.info(`Found ${o.length} sold items`,o),await this.processSoldItems(o)):f.debug("No sold items found"),await chrome.storage.local.set({[u]:Date.now()})}catch(e){f.error("Error during sale detection check:",e)}finally{this.isRunning=!1}}}async checkPoshmarkSales(){return f.debug("Checking Poshmark for sales (not implemented)"),[]}async checkMercariSales(){return f.debug("Checking Mercari for sales (not implemented)"),[]}async checkDepopSales(){return f.debug("Checking Depop for sales (not implemented)"),[]}async processSoldItems(e){f.info("Processing sold items:",e);for(const t of e)await this.showSaleNotification(t)}async showSaleNotification(e){((await chrome.storage.local.get(h))[h]||{}).notifications&&await chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"Item Sold!",message:`Your item sold on ${e.platform}. Auto-delisting from other platforms...`,priority:2})}async manualCheck(){f.info("Manual sale detection check triggered"),await this.startCheck()}async stop(){await chrome.alarms.clear(c),f.info("Sale detection stopped")}};let y=null,k=null;const b="mercari_api_auth",I=new class{constructor(){this.apiUrl="https://www.mercari.com/v1/api",this.auth=null}async extractAuth(){f.info("Extracting Mercari auth tokens from _mwus cookie");try{const e=(await chrome.storage.local.get(b))[b];if(e?.bearerToken&&e?.csrfToken)return f.info("Using cached Mercari auth tokens"),this.auth=e,this.auth;const t=["https://www.mercari.com","https://www.mercari.com/","https://www.mercari.com/sell/","https://mercari.com"];let r;for(const e of t)try{if(r=await chrome.cookies.get({url:e,name:"_mwus"}),r){f.info(`Found _mwus cookie for URL: ${e}`);break}}catch(t){f.debug(`Failed to get cookie for ${e}:`,t)}if(!r?.value){const e=await chrome.cookies.getAll({url:"https://www.mercari.com"});throw f.error("Available cookies:",e.map(e=>`${e.name} (httpOnly: ${e.httpOnly}, secure: ${e.secure})`).join(", ")),new Error("_mwus cookie not found. This cookie may be HttpOnly and inaccessible to extensions. You may need to visit mercari.com first.")}f.info("Found _mwus cookie, decoding...");const o=atob(r.value),a=JSON.parse(o);f.debug("Decoded _mwus structure:",Object.keys(a));const i=a.accessToken,s=a.csrfSecret;if(!i||!s)throw f.error("Decoded _mwus data:",a),new Error("Missing accessToken or csrfSecret in _mwus cookie");return f.info("Successfully extracted tokens from _mwus cookie"),this.auth={bearerToken:i,csrfToken:s},await chrome.storage.local.set({[b]:this.auth}),this.auth}catch(e){throw f.error("Failed to extract Mercari auth:",e),e}}async clearAuth(){this.auth=null,await chrome.storage.local.remove(b),f.info("Cleared cached Mercari auth")}async uploadImages(e){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Mercari");f.info(`Uploading ${e.length} images to Mercari`);try{const t=await Promise.all(e.map(async e=>{const t=await fetch(e);return await t.blob()})),r=[];for(let e=0;e<t.length;e++){const o=t[e];f.info(`Uploading image ${e+1}/${t.length}`);const a=await this.uploadSingleImage(o,e);r.push(a)}return f.info("All images uploaded successfully:",r),r}catch(e){throw f.error("Failed to upload images:",e),e}}async uploadSingleImage(e,t){if(!this.auth)throw new Error("Not authenticated");const r=new FormData;r.append("operations",JSON.stringify({operationName:"uploadTempListingPhotos",variables:{input:{photos:[null]}},extensions:{persistedQuery:{version:1,sha256Hash:"9aa889ac01e549a01c66c7baabc968b0e4a7fa4cd0b6bd32b7599ce10ca09a10"}}})),r.append("map",JSON.stringify({1:["variables.input.photos.0"]})),r.append("1",e,"image.jpg");const o=await fetch(this.apiUrl,{method:"POST",headers:{authorization:`Bearer ${this.auth.bearerToken}`,"x-csrf-token":this.auth.csrfToken,"x-app-version":"1","x-platform":"web","x-gql-migration":"1","apollo-require-preflight":"true"},body:r});if(!o.ok){const e=await o.text();throw new Error(`Image upload failed: ${o.status} ${e}`)}const a=await o.json();if(!a.data?.uploadTempListingPhotos?.uploadIds?.[0])throw new Error("Upload response missing uploadId");return a.data.uploadTempListingPhotos.uploadIds[0]}async createListing(e,t){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Mercari");f.info("Creating Mercari listing via API:",e.title);try{const r=Math.round(100*e.price),o=Math.round(.1*r),a=Math.round(.85*r),i=this.mapConditionToMercariId(e.condition),n=16*(e.weight_lb||0)+(e.weight_oz||0);let c=3373;if(e.mercari_category){const t=parseInt(e.mercari_category);isNaN(t)||(c=t)}let l=19044;if(e.mercari_brand_id)l=parseInt(e.mercari_brand_id),f.info(`Using provided Mercari brand ID: ${l}`);else if(e.brand){const t=await async function(e){if(!e)return null;const t=await async function(){return y||k||(k=(async()=>{try{const e=(await s.e(462).then(s.t.bind(s,462,19))).default;return y=e.data.master,y}catch(e){return console.error("Failed to load Mercari master data:",e),{itemCategories:[],itemBrands:[]}}})(),k)}(),r=e.toLowerCase().trim(),o=t.itemBrands.find(e=>e.name.toLowerCase()===r);if(o)return o.id;const a=t.itemBrands.find(e=>e.name.toLowerCase().includes(r)||r.includes(e.name.toLowerCase()));return a?a.id:null}(e.brand);t?(l=t,f.info(`Brand name mapping: "${e.brand}" -> ${l}`)):f.warn(`Brand "${e.brand}" not found in Mercari master data, using default: ${l}`)}else f.info(`No brand provided, using default: ${l}`);const d=function(e){return e<=4?[2128]:e<=8?[2129]:e<=12?[2130]:e<=16?[2131]:e<=32?[2132]:e<=48?[2133]:e<=80?[2134]:e<=160?[2135]:[2136]}(n);f.info(`Shipping class for ${n}oz: ${d}`);const h={extensions:{persistedQuery:{version:1,sha256Hash:"265dab5d0d382d3c83dda7d65e9ad111f47c27aa5d92c7d9a4bacd890d5e32c0"}},operationName:"createListing",variables:{input:{photoIds:t,name:e.title,price:r,description:e.description,categoryId:c,conditionId:i,shippingPayerId:2,zipCode:"90210",salesFee:o,shippingClassIds:d,suggestedShippingClassIds:d,shippingWeightUnit:"OUNCE",shippingDimensionUnit:"INCH",shippingPackageWeight:n||16,minPriceForAutoPriceDrop:a,offerConfig:{minPriceForSmartOffer:0},isShippingSoyo:!1,shippingPackageLength:12,shippingPackageHeight:10,shippingPackageWidth:12,brandId:l}}};f.debug("Creating listing with payload:",JSON.stringify(h.variables.input,null,2));const u=await fetch(this.apiUrl,{method:"POST",headers:{authorization:`Bearer ${this.auth.bearerToken}`,"x-csrf-token":this.auth.csrfToken,"x-app-version":"1","x-platform":"web","x-gql-migration":"1","apollo-require-preflight":"true","content-type":"application/json"},body:JSON.stringify(h)});if(!u.ok){const e=await u.text();throw f.error("Mercari API error response:",e),401!==u.status&&403!==u.status||await this.clearAuth(),new Error(`Listing creation failed: ${u.status} ${e}`)}const p=await u.json();if(f.info("Mercari listing creation response:",p),p.errors&&p.errors.length>0){f.error("GraphQL errors:",p.errors);const e=p.errors.map(e=>e.message).join(", ");throw new Error(`GraphQL errors: ${e}`)}const m=p.data?.createListing?.id;if(!m)throw f.error("Full response:",JSON.stringify(p,null,2)),new Error("Response missing listing ID");const g=`https://www.mercari.com/us/item/${m}`;return f.info("Successfully created Mercari listing:",m),{platformListingId:m,platformUrl:g}}catch(e){throw f.error("Failed to create Mercari listing:",e),e}}mapConditionToMercariId(e){return{new:1,like_new:2,good:3,fair:4,poor:5}[e.toLowerCase()]||3}async testAuth(){try{return await this.extractAuth(),!0}catch(e){return f.warn("Mercari auth test failed:",e),!1}}async deleteListing(e){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Mercari");f.info("Deleting Mercari listing via API:",e);try{const t={extensions:{persistedQuery:{version:1,sha256Hash:"55bd4e7d2bc2936638e1451da3231e484993635d7603431d1a2978e3d59656f8"}},operationName:"UpdateItemStatusMutation",variables:{input:{status:"cancel",id:e}}};f.debug("Deleting listing with payload:",JSON.stringify(t.variables,null,2));const r=await fetch(this.apiUrl,{method:"POST",headers:{authorization:`Bearer ${this.auth.bearerToken}`,"x-csrf-token":this.auth.csrfToken,"x-app-version":"1","x-platform":"web","apollo-require-preflight":"true","content-type":"application/json"},body:JSON.stringify(t)});if(!r.ok){const e=await r.text();throw f.error("Mercari API error response:",e),401!==r.status&&403!==r.status||await this.clearAuth(),new Error(`Listing deletion failed: ${r.status} ${e}`)}const o=await r.json();if(f.info("Mercari listing deletion response:",o),o.errors&&o.errors.length>0){f.error("GraphQL errors:",o.errors);const e=o.errors.map(e=>e.message).join(", ");throw new Error(`GraphQL errors: ${e}`)}f.info("Successfully deleted Mercari listing:",e)}catch(e){throw f.error("Failed to delete Mercari listing:",e),e}}async debugCookies(){const e=await chrome.cookies.getAll({domain:".mercari.com"});f.info("=== ALL MERCARI COOKIES ==="),e.forEach(e=>{f.info(`Cookie: ${e.name} = ${e.value.substring(0,50)}${e.value.length>50?"...":""}`)}),f.info("=== END COOKIES ===")}};globalThis.debugMercariCookies=async()=>{await I.debugCookies()};const E="poshmark_api_auth",T=new class{constructor(){this.baseUrl="https://poshmark.com",this.auth=null}async extractAuth(){f.info("Extracting Poshmark auth from cookies");try{const e=await chrome.cookies.getAll({domain:".poshmark.com"}),t=await chrome.cookies.getAll({domain:"poshmark.com"}),r=await chrome.cookies.getAll({url:"https://poshmark.com"}),o=[...e,...t,...r],a=new Map;o.forEach(e=>a.set(e.name,e));const i=Array.from(a.values());if(!i||0===i.length)throw new Error("No Poshmark cookies found. Please log in to Poshmark first.");f.info(`Found ${i.length} Poshmark cookies`),f.debug("Cookie names:",i.map(e=>e.name).join(", "));const s=(await chrome.storage.local.get(E))[E];let n=s?.userId;if(n)f.info("Using cached user ID:",n);else{const e=await this.extractUserId(i);if(!e)throw new Error("Could not extract Poshmark user ID");n=e,f.info("Extracted user ID from cookies:",n)}return this.auth={userId:n,cookies:i},await chrome.storage.local.set({[E]:{userId:n,cookies:[]}}),this.auth}catch(e){throw f.error("Failed to extract Poshmark auth:",e),e}}async extractUserId(e){try{const t=e.find(e=>"ui"===e.name);if(t?.value)try{const e=decodeURIComponent(t.value),r=JSON.parse(e);if(r.uid)return f.info("Extracted user ID from ui cookie:",r.uid),r.uid}catch(e){f.debug("Failed to parse ui cookie")}const r=e.find(e=>"jwt"===e.name);if(r?.value)try{const e=r.value.split(".");if(3===e.length){const t=JSON.parse(atob(e[1]));if(t.user_id)return f.info("Extracted user ID from JWT:",t.user_id),t.user_id}}catch(e){f.debug("Failed to parse JWT cookie")}return f.error("Could not find user ID in cookies"),null}catch(e){return f.error("Failed to extract user ID:",e),null}}async clearAuth(){this.auth=null,await chrome.storage.local.remove(E),f.info("Cleared cached Poshmark auth")}async uploadImages(e,t,r){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Poshmark");f.info(`Uploading ${e.length} images to Poshmark for post ${t}`);try{const o=[];for(let a=0;a<e.length;a++){const i=e[a];f.info(`Uploading image ${a+1}/${e.length}`);const s=await fetch(i),n=await s.blob(),c=await this.uploadSingleImage(n,t,a,r);o.push(c)}return f.info("All images uploaded successfully"),o}catch(e){throw f.error("Failed to upload images:",e),e}}async uploadSingleImage(e,t,r,o){if(!this.auth)throw new Error("Not authenticated");const a=new FormData;a.append("file",e,"image.jpg");const i=this.auth.cookies.map(e=>`${e.name}=${e.value}`).join("; "),s=await fetch(`${this.baseUrl}/api/posts/${t}/media/scratch`,{method:"POST",headers:{Cookie:i,"x-xsrf-token":o,origin:this.baseUrl,referer:`${this.baseUrl}/create-listing`},body:a});if(!s.ok){const e=await s.text();throw new Error(`Image upload failed: ${s.status} ${e}`)}const n=await s.json();return f.info(`Image ${r+1} uploaded:`,n),n}async createListing(e){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Poshmark");f.info("Creating Poshmark listing via API:",e.title);try{const t=await this.getCsrfToken();f.info("Got CSRF token");const r=(await this.createDraftPost(e,t)).id;f.info("Draft post created:",r);const o=await this.uploadImages(e.photo_urls,r,t);await this.updatePost(r,e,o,t);const a=`https://poshmark.com/listing/${r}`;return f.info("Successfully created Poshmark listing:",r),{platformListingId:r,platformUrl:a}}catch(e){throw f.error("Failed to create Poshmark listing:",e),e}}async getCsrfToken(){if(!this.auth)throw new Error("Not authenticated");try{const e=this.auth.cookies.map(e=>`${e.name}=${e.value}`).join("; "),t=await fetch(`${this.baseUrl}/create-listing`,{headers:{Cookie:e}});if(!t.ok)throw new Error("Failed to fetch create-listing page");const r=await t.text(),o=r.match(/<meta[^>]*name=["']csrf-token["'][^>]*content=["']([^"']+)["']/i)||r.match(/<meta[^>]*content=["']([^"']+)["'][^>]*name=["']csrf-token["']/i);if(o&&o[1])return f.info("Extracted CSRF token from meta tag"),o[1];const a=r.match(/csrfToken["']?\s*[:=]\s*["']([^"']+)["']/i)||r.match(/csrf["']?\s*[:=]\s*["']([^"']+)["']/i);if(a&&a[1])return f.info("Extracted CSRF token from script"),a[1];throw new Error("Could not find CSRF token in page")}catch(e){throw f.error("Failed to get CSRF token:",e),e}}async createDraftPost(e,t){if(!this.auth)throw new Error("Not authenticated");const r={post:{catalog:{department:e.poshmark_department||"583c7d134024035188906153",category:e.category||"518e4884402403bc7f6c6157",category_features:e.poshmark_category_features||[]},colors:e.colors||[],inventory:{size_quantity_revision:0,size_quantities:[{size_obj:{id:e.size||"OS",display:e.size||"One Size"},quantity_available:1,quantity_sold:0,size_set_tags:["standard"]}]},price_amount:{val:Math.floor(e.price).toString(),currency_code:"USD",currency_symbol:"$"},original_price_amount:{val:e.original_price?Math.floor(e.original_price).toString():Math.floor(2.5*e.price).toString(),currency_code:"USD",currency_symbol:"$"},title:e.title,description:e.description,brand:e.brand||"other",condition:this.mapConditionToPoshmark(e.condition),cover_shot:{},pictures:[],seller_private_info:{},seller_shipping_discount:{id:"5ff7647a5d29bbebfa25f9d0"},videos:[]}},o=this.auth.cookies.map(e=>`${e.name}=${e.value}`).join("; "),a=await fetch(`${this.baseUrl}/vm-rest/users/${this.auth.userId}/posts`,{method:"POST",headers:{"Content-Type":"application/json",Cookie:o,"x-xsrf-token":t,accept:"application/json",origin:this.baseUrl,referer:`${this.baseUrl}/create-listing`},body:JSON.stringify(r)});if(!a.ok){const e=await a.text();throw f.error("Poshmark API error response:",e),401!==a.status&&403!==a.status||await this.clearAuth(),new Error(`Draft post creation failed: ${a.status} ${e}`)}const i=await a.json();if(f.info("Poshmark draft post creation response:",i),i.error)throw f.error("Poshmark API returned error:",i.error),new Error(`Draft post creation failed: ${JSON.stringify(i.error)}`);return i}async updatePost(e,t,r,o){if(!this.auth)throw new Error("Not authenticated");const a={post:{catalog:{department:t.poshmark_department||"583c7d134024035188906153",category:t.category||"518e4884402403bc7f6c6157",category_features:t.poshmark_category_features||[]},colors:t.colors||[],inventory:{size_quantity_revision:0,size_quantities:[{size_obj:{id:t.size||"OS",display:t.size||"One Size"},quantity_available:1,quantity_sold:0,size_set_tags:["standard"]}]},price_amount:{val:Math.floor(t.price).toString(),currency_code:"USD",currency_symbol:"$"},original_price_amount:{val:t.original_price?Math.floor(t.original_price).toString():Math.floor(2.5*t.price).toString(),currency_code:"USD",currency_symbol:"$"},title:t.title,description:t.description,brand:t.brand||"other",condition:this.mapConditionToPoshmark(t.condition),cover_shot:r[0]||{},pictures:r,seller_private_info:{},seller_shipping_discount:{id:"5ff7647a5d29bbebfa25f9d0"},videos:[]}},i=this.auth.cookies.map(e=>`${e.name}=${e.value}`).join("; "),s=await fetch(`${this.baseUrl}/vm-rest/posts/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",Cookie:i,"x-xsrf-token":o,accept:"application/json",origin:this.baseUrl,referer:`${this.baseUrl}/create-listing`},body:JSON.stringify(a)});if(!s.ok){const e=await s.text();throw new Error(`Post update failed: ${s.status} ${e}`)}f.info("Post updated successfully with images")}mapConditionToPoshmark(e){return{new:"nwt",like_new:"nwt",good:"good",fair:"fair",poor:"poor"}[e.toLowerCase()]||"good"}async testAuth(){try{return await this.extractAuth(),!0}catch(e){return f.warn("Poshmark auth test failed:",e),!1}}};async function v(e){f.info("Handling WebSocket message:",e.type);try{switch(e.type){case"CREATE_LISTING":await async function(e,t){const{platform:r,listingData:o,userId:a}=e;f.info(`Creating listing on ${r}:`,o.title);try{await g.markJobInProgress(t)}catch(e){f.warn("Failed to mark job as in_progress:",e)}if(await $(o.id,r,"uploading_images",0),"mercari"!==r)if("poshmark"!==r)try{const e=n[r]?.createListing;if(!e)throw new Error(`Unknown platform: ${r}`);const t=await chrome.windows.create({url:e,type:"normal",focused:!0,state:"normal"}),a=t.tabs?.[0];if(!a?.id||!t.id)throw new Error("Failed to create tab in window");f.info(`Created listing tab ${a.id} in window ${t.id}`),await _(a.id);const i=(await chrome.windows.getAll()).find(e=>e.id!==t.id&&e.focused);i?.id&&(await chrome.windows.update(i.id,{focused:!0}),f.info("Refocused previous window, listing window now in background"));const s=p("CREATE_LISTING",{listingData:o}),c=await m(a.id,s);if(!1===c.success)throw new Error(c.error||"Listing creation failed");await g.sendResult({success:!0,listingId:o.id,platform:r,platformListingId:c.platformListingId,platformUrl:c.platformUrl,operationType:"CREATE"}),setTimeout(()=>{t.id&&chrome.windows.remove(t.id)},2e3),f.info("Listing created successfully:",c)}catch(e){throw f.error("Failed to create listing:",e),await g.sendResult({success:!1,listingId:o.id,platform:r,error:e instanceof Error?e.message:"Unknown error",operationType:"CREATE"}),f.info("Window kept open for debugging. Check the platform page for validation errors."),e}else try{f.info("Using API-based creation for Poshmark (no windows)"),await $(o.id,r,"uploading_images",25);const e=await T.createListing(o);await $(o.id,r,"completed",100),await g.sendResult({success:!0,listingId:o.id,platform:r,platformListingId:e.platformListingId,platformUrl:e.platformUrl,operationType:"CREATE"}),f.info("Poshmark listing created via API:",e)}catch(e){throw f.error("Failed to create Poshmark listing via API:",e),await g.sendResult({success:!1,listingId:o.id,platform:r,error:e instanceof Error?e.message:"Unknown error",operationType:"CREATE"}),e}else try{f.info("Using API-based creation for Mercari (no windows)");const e=await I.uploadImages(o.photo_urls);f.info("Images uploaded, got uploadIds:",e),await $(o.id,r,"filling_form",50);const t=await I.createListing(o,e);await $(o.id,r,"completed",100),await g.sendResult({success:!0,listingId:o.id,platform:r,platformListingId:t.platformListingId,platformUrl:t.platformUrl,operationType:"CREATE"}),f.info("Mercari listing created via API:",t)}catch(e){throw f.error("Failed to create Mercari listing via API:",e),await g.sendResult({success:!1,listingId:o.id,platform:r,error:e instanceof Error?e.message:"Unknown error",operationType:"CREATE"}),e}}(e.payload,e.requestId);break;case"DELETE_LISTING":await async function(e,t){const{platform:r,platformListingId:o,reason:a}=e;if(f.info(`Deleting listing ${o} on ${r} (reason: ${a}), jobId: ${t}`),"mercari"!==r)try{let e;switch(r){case"poshmark":return void f.warn("Poshmark deletion not yet implemented");case"depop":return void f.warn("Depop deletion not yet implemented");default:throw new Error(`Unknown platform: ${r}`)}const t=await chrome.windows.create({url:e,type:"normal",focused:!1,state:"normal"}),i=t.tabs?.[0];if(!i||"number"!=typeof i?.id)throw new Error("Failed to create tab in minimized window");const s=i.id;f.info(`Opened ${r} edit page in tab ${s} in minimized window ${t.id}`),await _(s);const n=p("DELETE_LISTING",{platformListingId:o,reason:a}),c=await m(s,n);setTimeout(()=>{t.id&&chrome.windows.remove(t.id)},2e3),f.info("Listing deleted successfully:",c),await g.sendResult({success:!0,listingId:"",platform:r,platformListingId:o,platformUrl:e,operationType:"DELETE"})}catch(e){throw f.error("Failed to delete listing:",e),await g.sendResult({success:!1,listingId:"",platform:r,platformListingId:o,error:e instanceof Error?e.message:"Unknown error",operationType:"DELETE"}),e}else try{f.info("Using API-based deletion for Mercari (no windows)"),await I.deleteListing(o),await g.sendResult({success:!0,jobId:t,listingId:"",platform:r,platformListingId:o,platformUrl:`https://www.mercari.com/us/item/${o}`,operationType:"DELETE"}),f.info("Mercari listing deleted via API:",o)}catch(e){throw f.error("Failed to delete Mercari listing via API:",e),await g.sendResult({success:!1,jobId:t,listingId:"",platform:r,platformListingId:o,error:e instanceof Error?e.message:"Unknown error",operationType:"DELETE"}),e}}(e.payload,e.requestId);break;case"CHECK_STATUS":await async function(){await Promise.all(["poshmark","mercari","depop"].map(e=>S(e)))}();break;default:f.warn("Unhandled WebSocket message type:",e.type)}}catch(e){f.error("Error handling message:",e)}}async function S(e){return{platform:e,loggedIn:!1,lastChecked:Date.now()}}async function $(e,t,r,o,a){f.debug("Progress update:",{listingId:e,platform:t,status:r,progress:o})}function _(e){return new Promise((t,r)=>{const o=setTimeout(()=>{r(new Error("Tab load timeout"))},3e4);chrome.tabs.onUpdated.addListener(function r(a,i){a===e&&"complete"===i.status&&(clearTimeout(o),chrome.tabs.onUpdated.removeListener(r),setTimeout(t,8e3))})})}chrome.runtime.onInstalled.addListener(async e=>{f.info("Extension installed/updated:",e.reason),"install"===e.reason&&(await chrome.storage.local.set({settings:{autoDelete:!0,checkInterval:10,notifications:!0},platformConnections:[]}),await chrome.tabs.create({url:"https://compr.co/extension-installed"})),await w.initialize()}),chrome.runtime.onStartup.addListener(async()=>{f.info("Extension started"),await g.connect(),await w.initialize()}),chrome.alarms.onAlarm.addListener(async e=>{e.name===c&&(f.info("Sale detection alarm triggered"),await w.startCheck())}),chrome.runtime.onMessage.addListener((e,t,r)=>{switch(f.debug("Received message:",e.type,e),e.type){case"WS_MESSAGE_RECEIVED":return v(e.message).then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0;case"CONNECTION_STATUS":r({connected:g.connected});break;case"CONNECT_BACKEND":return async function(e){const{userId:t,authToken:r}=e;if(!t||!r)throw new Error("Missing userId or authToken");await g.updateAuth(t,r),f.info("Backend connection updated with new credentials")}(e.payload).then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0;case"VERIFY_SESSION":return async function(e){const{platform:t}=e;f.info(`Verifying session for ${t}`);try{const e=n[t]?.base;if(!e)throw new Error(`Unknown platform: ${t}`);const r=await chrome.tabs.query({url:`${e}/*`});let o;if(r.length>0&&r[0].id)o=r[0].id,f.info(`Using existing ${t} tab`);else{const t=await chrome.tabs.create({url:e,active:!1});if(!t.id)throw new Error("Failed to create tab");o=t.id,await _(o)}const a=p("CHECK_LOGIN",{});f.info(`Sending CHECK_LOGIN message to ${t} tab ${o}`);try{const e=await m(o,a);f.info(`${t} content script response:`,e),0===r.length&&setTimeout(()=>{f.info(`Closing ${t} verification tab ${o}`),chrome.tabs.remove(o)},1e4);const i=e.loggedIn;return f.info(`${t} verification result - DOM check: ${i}`),i?(f.info(`Session verified for ${t}`),{success:!0}):(f.warn(`Not logged in to ${t}`),{success:!1,error:`Not logged in to ${t}. Please log in and try again.`})}catch(e){return f.error(`${t} content script error:`,e),0===r.length&&setTimeout(()=>{chrome.tabs.remove(o)},2e3),{success:!1,error:"Extension verification failed. Please reload the extension at chrome://extensions and try again."}}}catch(e){return f.error("Session verification error:",e),{success:!1,error:`Verification error: ${e instanceof Error?e.message:"Unknown error during verification"}. Try reloading the extension.`}}}(e.payload).then(e=>r(e)).catch(e=>r({success:!1,error:e.message})),!0;case"MANUAL_SALE_CHECK":return w.manualCheck().then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0;case"GET_PLATFORM_STATUS":return S(e.payload.platform).then(e=>r(e)).catch(e=>r({error:e.message})),!0;default:f.warn("Unknown message type:",e.type)}}),setInterval(()=>{g.connected&&f.debug("Service worker keepalive")},2e4),g.connect(),globalThis.testDeleteListing=async e=>{f.info("TEST: Triggering deletion for",e),await v({type:"DELETE_LISTING",payload:{platform:"mercari",platformListingId:e,reason:"test_deletion"},requestId:"test-"+Date.now(),timestamp:Date.now()})},f.info("Background service worker initialized")})();