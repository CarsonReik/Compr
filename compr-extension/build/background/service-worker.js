(()=>{"use strict";var e,t,r,o,a={},i={};function n(e){var t=i[e];if(void 0!==t)return t.exports;var r=i[e]={exports:{}};return a[e](r,r.exports,n),r.exports}n.m=a,t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,n.t=function(r,o){if(1&o&&(r=this(r)),8&o)return r;if("object"==typeof r&&r){if(4&o&&r.__esModule)return r;if(16&o&&"function"==typeof r.then)return r}var a=Object.create(null);n.r(a);var i={};e=e||[null,t({}),t([]),t(t)];for(var s=2&o&&r;("object"==typeof s||"function"==typeof s)&&!~e.indexOf(s);s=t(s))Object.getOwnPropertyNames(s).forEach(e=>i[e]=()=>r[e]);return i.default=()=>r,n.d(a,i),a},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce((t,r)=>(n.f[r](e,t),t),[])),n.u=e=>e+".js",n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r={},o="compr-extension:",n.l=(e,t,a,i)=>{if(r[e])r[e].push(t);else{var s,c;if(void 0!==a)for(var l=document.getElementsByTagName("script"),d=0;d<l.length;d++){var u=l[d];if(u.getAttribute("src")==e||u.getAttribute("data-webpack")==o+a){s=u;break}}s||(c=!0,(s=document.createElement("script")).charset="utf-8",n.nc&&s.setAttribute("nonce",n.nc),s.setAttribute("data-webpack",o+a),s.src=e),r[e]=[t];var h=(t,o)=>{s.onerror=s.onload=null,clearTimeout(p);var a=r[e];if(delete r[e],s.parentNode&&s.parentNode.removeChild(s),a&&a.forEach(e=>e(o)),t)return t(o)},p=setTimeout(h.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=h.bind(null,s.onerror),s.onload=h.bind(null,s.onload),c&&document.head.appendChild(s)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e+"../"})(),(()=>{var e={458:0};n.f.j=(t,r)=>{var o=n.o(e,t)?e[t]:void 0;if(0!==o)if(o)r.push(o[2]);else{var a=new Promise((r,a)=>o=e[t]=[r,a]);r.push(o[2]=a);var i=n.p+n.u(t),s=new Error;n.l(i,r=>{if(n.o(e,t)&&(0!==(o=e[t])&&(e[t]=void 0),o)){var a=r&&("load"===r.type?"missing":r.type),i=r&&r.target&&r.target.src;s.message="Loading chunk "+t+" failed.\n("+a+": "+i+")",s.name="ChunkLoadError",s.type=a,s.request=i,o[1](s)}},"chunk-"+t,t)}};var t=(t,r)=>{var o,a,[i,s,c]=r,l=0;if(i.some(t=>0!==e[t])){for(o in s)n.o(s,o)&&(n.m[o]=s[o]);c&&c(n)}for(t&&t(r);l<i.length;l++)a=i[l],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0},r=self.webpackChunkcompr_extension=self.webpackChunkcompr_extension||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})(),n.d({},{B:()=>T});const s={poshmark:{base:"https://poshmark.com",login:"https://poshmark.com/login",createListing:"https://poshmark.com/create-listing",mySales:"https://poshmark.com/sales"},mercari:{base:"https://www.mercari.com",login:"https://www.mercari.com/login",createListing:"https://www.mercari.com/sell"},depop:{base:"https://www.depop.com",login:"https://www.depop.com/login",createListing:"https://www.depop.com/products/create"}},c="saleDetectionAlarm",l="userId",d="authToken",u="settings",h="lastSaleCheck";function p(e,t,r){return{type:e,payload:t,requestId:r||`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now()}}async function m(e,t){return new Promise((r,o)=>{chrome.tabs.sendMessage(e,t,e=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):r(e)})})}const g={debug:(...e)=>{},info:(...e)=>{console.info("[Compr Extension]",...e)},warn:(...e)=>{console.warn("[Compr Extension]",...e)},error:(...e)=>{console.error("[Compr Extension]",...e)}},f=new class{constructor(){this.userId=null,this.authToken=null,this.pollingInterval=null,this.isPolling=!1;const e=chrome.runtime.getManifest().version.includes("dev")||"1.0.0"===chrome.runtime.getManifest().version;this.baseUrl=e?"http://localhost:3000":"https://compr.co"}async loadSettings(){const e=await chrome.storage.local.get([l,d]);this.userId=e[l]||null,this.authToken=e[d]||null,g.debug("HTTP client settings loaded",{hasUserId:!!this.userId,hasAuthToken:!!this.authToken})}async updateAuth(e,t){this.userId=e,this.authToken=t,await chrome.storage.local.set({[l]:e,[d]:t}),await this.connect()}async connect(){if(this.userId&&this.authToken||await this.loadSettings(),this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/connect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,platformStatuses:[]})});if(!e.ok)throw new Error(`Connect failed: ${e.statusText}`);const t=await e.json();if(g.info("Connected to backend:",t),t.pendingJobs&&t.pendingJobs.length>0)for(const e of t.pendingJobs)await this.handleCreateListing(e);this.startPolling()}catch(e){g.error("Failed to connect to backend:",e)}else g.warn("Cannot connect: missing userId or authToken")}startPolling(){this.isPolling?g.debug("Already polling"):(this.isPolling=!0,g.info("Starting job polling"),this.pollingInterval=setInterval(()=>{this.poll()},5e3))}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isPolling=!1,g.info("Stopped polling")}async poll(){if(this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/poll?userId=${this.userId}&authToken=${this.authToken}`);if(!e.ok)return void g.warn("Poll failed:",e.statusText);const t=await e.json();if(t.hasNewJobs&&t.jobs){g.info(`Found ${t.jobs.length} new jobs`);for(const e of t.jobs)await this.handleCreateListing(e)}}catch(e){g.error("Polling error:",e)}}async handleCreateListing(e){const{jobId:t,platform:r,listingData:o}=e;g.info(`Processing job ${t}: Create listing on ${r}`),await T({type:"CREATE_LISTING",payload:{platform:r,listingData:o,userId:this.userId},requestId:t,timestamp:Date.now()})}async markJobInProgress(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/job-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,jobId:e,status:"processing"})});if(!t.ok)throw new Error(`Failed to mark job in progress: ${t.statusText}`);g.info("Job marked as in_progress:",e)}catch(e){throw g.error("Failed to mark job in progress:",e),e}else g.warn("Cannot mark job in progress: missing credentials")}async sendResult(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/callback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,result:e})});if(!t.ok)throw new Error(`Callback failed: ${t.statusText}`);g.info("Result sent successfully")}catch(e){g.error("Failed to send result:",e)}else g.warn("Cannot send result: missing credentials")}get connected(){return this.isPolling&&!!this.userId&&!!this.authToken}},w=new class{constructor(){this.isRunning=!1}async initialize(){g.info("Initializing sale detection framework");const e=(await chrome.storage.local.get(u))[u]||{};if(!e.autoDelete)return void g.info("Auto-delete is disabled, skipping sale detection setup");const t=e.checkInterval||10;await chrome.alarms.create(c,{periodInMinutes:t,delayInMinutes:t}),g.info(`Sale detection alarm created (every ${t} minutes)`)}async startCheck(){if(this.isRunning)g.warn("Sale detection already running");else{this.isRunning=!0,g.info("Starting sale detection check");try{const e=await this.checkPoshmarkSales(),t=await this.checkMercariSales(),r=await this.checkDepopSales(),o=[...e,...t,...r];o.length>0?(g.info(`Found ${o.length} sold items`,o),await this.processSoldItems(o)):g.debug("No sold items found"),await chrome.storage.local.set({[h]:Date.now()})}catch(e){g.error("Error during sale detection check:",e)}finally{this.isRunning=!1}}}async checkPoshmarkSales(){return g.debug("Checking Poshmark for sales (not implemented)"),[]}async checkMercariSales(){return g.debug("Checking Mercari for sales (not implemented)"),[]}async checkDepopSales(){return g.debug("Checking Depop for sales (not implemented)"),[]}async processSoldItems(e){g.info("Processing sold items:",e);for(const t of e)await this.showSaleNotification(t)}async showSaleNotification(e){((await chrome.storage.local.get(u))[u]||{}).notifications&&await chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"Item Sold!",message:`Your item sold on ${e.platform}. Auto-delisting from other platforms...`,priority:2})}async manualCheck(){g.info("Manual sale detection check triggered"),await this.startCheck()}async stop(){await chrome.alarms.clear(c),g.info("Sale detection stopped")}};let b=null,y=null;const k="mercari_api_auth",I=new class{constructor(){this.apiUrl="https://www.mercari.com/v1/api",this.auth=null}async extractAuth(){g.info("Extracting Mercari auth tokens from _mwus cookie");try{const e=(await chrome.storage.local.get(k))[k];if(e?.bearerToken&&e?.csrfToken)return g.info("Using cached Mercari auth tokens"),this.auth=e,this.auth;const t=["https://www.mercari.com","https://www.mercari.com/","https://www.mercari.com/sell/","https://mercari.com"];let r;for(const e of t)try{if(r=await chrome.cookies.get({url:e,name:"_mwus"}),r){g.info(`Found _mwus cookie for URL: ${e}`);break}}catch(t){g.debug(`Failed to get cookie for ${e}:`,t)}if(!r?.value){const e=await chrome.cookies.getAll({url:"https://www.mercari.com"});throw g.error("Available cookies:",e.map(e=>`${e.name} (httpOnly: ${e.httpOnly}, secure: ${e.secure})`).join(", ")),new Error("_mwus cookie not found. This cookie may be HttpOnly and inaccessible to extensions. You may need to visit mercari.com first.")}g.info("Found _mwus cookie, decoding...");const o=atob(r.value),a=JSON.parse(o);g.debug("Decoded _mwus structure:",Object.keys(a));const i=a.accessToken,n=a.csrfSecret;if(!i||!n)throw g.error("Decoded _mwus data:",a),new Error("Missing accessToken or csrfSecret in _mwus cookie");return g.info("Successfully extracted tokens from _mwus cookie"),this.auth={bearerToken:i,csrfToken:n},await chrome.storage.local.set({[k]:this.auth}),this.auth}catch(e){throw g.error("Failed to extract Mercari auth:",e),e}}async clearAuth(){this.auth=null,await chrome.storage.local.remove(k),g.info("Cleared cached Mercari auth")}async uploadImages(e){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Mercari");g.info(`Uploading ${e.length} images to Mercari`);try{const t=await Promise.all(e.map(async e=>{const t=await fetch(e);return await t.blob()})),r=[];for(let e=0;e<t.length;e++){const o=t[e];g.info(`Uploading image ${e+1}/${t.length}`);const a=await this.uploadSingleImage(o,e);r.push(a)}return g.info("All images uploaded successfully:",r),r}catch(e){throw g.error("Failed to upload images:",e),e}}async uploadSingleImage(e,t){if(!this.auth)throw new Error("Not authenticated");const r=new FormData;r.append("operations",JSON.stringify({operationName:"uploadTempListingPhotos",variables:{input:{photos:[null]}},extensions:{persistedQuery:{version:1,sha256Hash:"9aa889ac01e549a01c66c7baabc968b0e4a7fa4cd0b6bd32b7599ce10ca09a10"}}})),r.append("map",JSON.stringify({1:["variables.input.photos.0"]})),r.append("1",e,"image.jpg");const o=await fetch(this.apiUrl,{method:"POST",headers:{authorization:`Bearer ${this.auth.bearerToken}`,"x-csrf-token":this.auth.csrfToken,"x-app-version":"1","x-platform":"web","x-gql-migration":"1","apollo-require-preflight":"true"},body:r});if(!o.ok){const e=await o.text();throw new Error(`Image upload failed: ${o.status} ${e}`)}const a=await o.json();if(!a.data?.uploadTempListingPhotos?.uploadIds?.[0])throw new Error("Upload response missing uploadId");return a.data.uploadTempListingPhotos.uploadIds[0]}async createListing(e,t){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Mercari");g.info("Creating Mercari listing via API:",e.title);try{const r=Math.round(100*e.price),o=Math.round(.1*r),a=Math.round(.85*r),i=this.mapConditionToMercariId(e.condition),s=16*(e.weight_lb||0)+(e.weight_oz||0);let c=3373;if(e.mercari_category){const t=parseInt(e.mercari_category);isNaN(t)||(c=t)}let l=19044;if(e.mercari_brand_id)l=parseInt(e.mercari_brand_id),g.info(`Using provided Mercari brand ID: ${l}`);else if(e.brand){const t=await async function(e){if(!e)return null;const t=await async function(){return b||y||(y=(async()=>{try{const e=(await n.e(462).then(n.t.bind(n,462,19))).default;return b=e.data.master,b}catch(e){return console.error("Failed to load Mercari master data:",e),{itemCategories:[],itemBrands:[]}}})(),y)}(),r=e.toLowerCase().trim(),o=t.itemBrands.find(e=>e.name.toLowerCase()===r);if(o)return o.id;const a=t.itemBrands.find(e=>e.name.toLowerCase().includes(r)||r.includes(e.name.toLowerCase()));return a?a.id:null}(e.brand);t?(l=t,g.info(`Brand name mapping: "${e.brand}" -> ${l}`)):g.warn(`Brand "${e.brand}" not found in Mercari master data, using default: ${l}`)}else g.info(`No brand provided, using default: ${l}`);const d=function(e){return e<=4?[2128]:e<=8?[2129]:e<=12?[2130]:e<=16?[2131]:e<=32?[2132]:e<=48?[2133]:e<=80?[2134]:e<=160?[2135]:[2136]}(s);g.info(`Shipping class for ${s}oz: ${d}`);const u={extensions:{persistedQuery:{version:1,sha256Hash:"265dab5d0d382d3c83dda7d65e9ad111f47c27aa5d92c7d9a4bacd890d5e32c0"}},operationName:"createListing",variables:{input:{photoIds:t,name:e.title,price:r,description:e.description,categoryId:c,conditionId:i,shippingPayerId:2,zipCode:"90210",salesFee:o,shippingClassIds:d,suggestedShippingClassIds:d,shippingWeightUnit:"OUNCE",shippingDimensionUnit:"INCH",shippingPackageWeight:s||16,minPriceForAutoPriceDrop:a,offerConfig:{minPriceForSmartOffer:0},isShippingSoyo:!1,shippingPackageLength:12,shippingPackageHeight:10,shippingPackageWidth:12,brandId:l}}};g.debug("Creating listing with payload:",JSON.stringify(u.variables.input,null,2));const h=await fetch(this.apiUrl,{method:"POST",headers:{authorization:`Bearer ${this.auth.bearerToken}`,"x-csrf-token":this.auth.csrfToken,"x-app-version":"1","x-platform":"web","x-gql-migration":"1","apollo-require-preflight":"true","content-type":"application/json"},body:JSON.stringify(u)});if(!h.ok){const e=await h.text();throw g.error("Mercari API error response:",e),401!==h.status&&403!==h.status||await this.clearAuth(),new Error(`Listing creation failed: ${h.status} ${e}`)}const p=await h.json();if(g.info("Mercari listing creation response:",p),p.errors&&p.errors.length>0){g.error("GraphQL errors:",p.errors);const e=p.errors.map(e=>e.message).join(", ");throw new Error(`GraphQL errors: ${e}`)}const m=p.data?.createListing?.id;if(!m)throw g.error("Full response:",JSON.stringify(p,null,2)),new Error("Response missing listing ID");const f=`https://www.mercari.com/us/item/${m}`;return g.info("Successfully created Mercari listing:",m),{platformListingId:m,platformUrl:f}}catch(e){throw g.error("Failed to create Mercari listing:",e),e}}mapConditionToMercariId(e){return{new:1,like_new:2,good:3,fair:4,poor:5}[e.toLowerCase()]||3}async testAuth(){try{return await this.extractAuth(),!0}catch(e){return g.warn("Mercari auth test failed:",e),!1}}async debugCookies(){const e=await chrome.cookies.getAll({domain:".mercari.com"});g.info("=== ALL MERCARI COOKIES ==="),e.forEach(e=>{g.info(`Cookie: ${e.name} = ${e.value.substring(0,50)}${e.value.length>50?"...":""}`)}),g.info("=== END COOKIES ===")}};async function T(e){g.info("Handling WebSocket message:",e.type);try{switch(e.type){case"CREATE_LISTING":await async function(e,t){const{platform:r,listingData:o,userId:a}=e;g.info(`Creating listing on ${r}:`,o.title);try{await f.markJobInProgress(t)}catch(e){g.warn("Failed to mark job as in_progress:",e)}if(await v(o.id,r,"uploading_images",0),"mercari"!==r)try{const e=s[r]?.createListing;if(!e)throw new Error(`Unknown platform: ${r}`);const t=await chrome.windows.create({url:e,type:"normal",focused:!0,state:"normal"}),a=t.tabs?.[0];if(!a?.id||!t.id)throw new Error("Failed to create tab in window");g.info(`Created listing tab ${a.id} in window ${t.id}`),await S(a.id);const i=(await chrome.windows.getAll()).find(e=>e.id!==t.id&&e.focused);i?.id&&(await chrome.windows.update(i.id,{focused:!0}),g.info("Refocused previous window, listing window now in background"));const n=p("CREATE_LISTING",{listingData:o}),c=await m(a.id,n);if(!1===c.success)throw new Error(c.error||"Listing creation failed");await f.sendResult({success:!0,listingId:o.id,platform:r,platformListingId:c.platformListingId,platformUrl:c.platformUrl,operationType:"CREATE"}),setTimeout(()=>{t.id&&chrome.windows.remove(t.id)},2e3),g.info("Listing created successfully:",c)}catch(e){throw g.error("Failed to create listing:",e),await f.sendResult({success:!1,listingId:o.id,platform:r,error:e instanceof Error?e.message:"Unknown error",operationType:"CREATE"}),g.info("Window kept open for debugging. Check the platform page for validation errors."),e}else try{g.info("Using API-based creation for Mercari (no windows)");const e=await I.uploadImages(o.photo_urls);g.info("Images uploaded, got uploadIds:",e),await v(o.id,r,"filling_form",50);const t=await I.createListing(o,e);await v(o.id,r,"completed",100),await f.sendResult({success:!0,listingId:o.id,platform:r,platformListingId:t.platformListingId,platformUrl:t.platformUrl,operationType:"CREATE"}),g.info("Mercari listing created via API:",t)}catch(e){throw g.error("Failed to create Mercari listing via API:",e),await f.sendResult({success:!1,listingId:o.id,platform:r,error:e instanceof Error?e.message:"Unknown error",operationType:"CREATE"}),e}}(e.payload,e.requestId);break;case"DELETE_LISTING":await async function(e){const{platform:t,platformListingId:r,reason:o}=e;g.info(`Deleting listing ${r} on ${t} (reason: ${o})`);try{let e;switch(t){case"mercari":e=`https://www.mercari.com/sell/edit/${r}`;break;case"poshmark":return void g.warn("Poshmark deletion not yet implemented");case"depop":return void g.warn("Depop deletion not yet implemented");default:throw new Error(`Unknown platform: ${t}`)}const a=await chrome.windows.create({url:e,type:"normal",focused:!1,state:"normal"}),i=a.tabs?.[0];if(!i?.id)throw new Error("Failed to create tab in minimized window");g.info(`Opened ${t} edit page in tab ${i.id} in minimized window ${a.id}`),await S(i.id);const n=p("DELETE_LISTING",{platformListingId:r,reason:o}),s=await m(i.id,n);setTimeout(()=>{a.id&&chrome.windows.remove(a.id)},2e3),g.info("Listing deleted successfully:",s),await f.sendResult({success:!0,listingId:"",platform:t,platformListingId:r,platformUrl:e,operationType:"DELETE"})}catch(e){throw g.error("Failed to delete listing:",e),await f.sendResult({success:!1,listingId:"",platform:t,platformListingId:r,error:e instanceof Error?e.message:"Unknown error",operationType:"DELETE"}),e}}(e.payload);break;case"CHECK_STATUS":await async function(){await Promise.all(["poshmark","mercari","depop"].map(e=>E(e)))}();break;default:g.warn("Unhandled WebSocket message type:",e.type)}}catch(e){g.error("Error handling message:",e)}}async function E(e){return{platform:e,loggedIn:!1,lastChecked:Date.now()}}async function v(e,t,r,o,a){g.debug("Progress update:",{listingId:e,platform:t,status:r,progress:o})}function S(e){return new Promise((t,r)=>{const o=setTimeout(()=>{r(new Error("Tab load timeout"))},3e4);chrome.tabs.onUpdated.addListener(function r(a,i){a===e&&"complete"===i.status&&(clearTimeout(o),chrome.tabs.onUpdated.removeListener(r),setTimeout(t,8e3))})})}globalThis.debugMercariCookies=async()=>{await I.debugCookies()},chrome.runtime.onInstalled.addListener(async e=>{g.info("Extension installed/updated:",e.reason),"install"===e.reason&&(await chrome.storage.local.set({settings:{autoDelete:!0,checkInterval:10,notifications:!0},platformConnections:[]}),await chrome.tabs.create({url:"https://compr.co/extension-installed"})),await w.initialize()}),chrome.runtime.onStartup.addListener(async()=>{g.info("Extension started"),await f.connect(),await w.initialize()}),chrome.alarms.onAlarm.addListener(async e=>{e.name===c&&(g.info("Sale detection alarm triggered"),await w.startCheck())}),chrome.runtime.onMessage.addListener((e,t,r)=>{switch(g.debug("Received message:",e.type,e),e.type){case"WS_MESSAGE_RECEIVED":return T(e.message).then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0;case"CONNECTION_STATUS":r({connected:f.connected});break;case"CONNECT_BACKEND":return async function(e){const{userId:t,authToken:r}=e;if(!t||!r)throw new Error("Missing userId or authToken");await f.updateAuth(t,r),g.info("Backend connection updated with new credentials")}(e.payload).then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0;case"VERIFY_SESSION":return async function(e){const{platform:t}=e;g.info(`Verifying session for ${t}`);try{const e=s[t]?.base;if(!e)throw new Error(`Unknown platform: ${t}`);const r=await chrome.tabs.query({url:`${e}/*`});let o;if(r.length>0&&r[0].id)o=r[0].id,g.info(`Using existing ${t} tab`);else{const t=await chrome.tabs.create({url:e,active:!1});if(!t.id)throw new Error("Failed to create tab");o=t.id,await S(o)}const a=p("CHECK_LOGIN",{});g.info(`Sending CHECK_LOGIN message to ${t} tab ${o}`);try{const e=await m(o,a);g.info(`${t} content script response:`,e),0===r.length&&setTimeout(()=>{g.info(`Closing ${t} verification tab ${o}`),chrome.tabs.remove(o)},1e4);const i=e.loggedIn;return g.info(`${t} verification result - DOM check: ${i}`),i?(g.info(`Session verified for ${t}`),{success:!0}):(g.warn(`Not logged in to ${t}`),{success:!1,error:`Not logged in to ${t}. Please log in and try again.`})}catch(e){return g.error(`${t} content script error:`,e),0===r.length&&setTimeout(()=>{chrome.tabs.remove(o)},2e3),{success:!1,error:"Extension verification failed. Please reload the extension at chrome://extensions and try again."}}}catch(e){return g.error("Session verification error:",e),{success:!1,error:`Verification error: ${e instanceof Error?e.message:"Unknown error during verification"}. Try reloading the extension.`}}}(e.payload).then(e=>r(e)).catch(e=>r({success:!1,error:e.message})),!0;case"MANUAL_SALE_CHECK":return w.manualCheck().then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0;case"GET_PLATFORM_STATUS":return E(e.payload.platform).then(e=>r(e)).catch(e=>r({error:e.message})),!0;default:g.warn("Unknown message type:",e.type)}}),setInterval(()=>{f.connected&&g.debug("Service worker keepalive")},2e4),f.connect(),globalThis.testDeleteListing=async e=>{g.info("TEST: Triggering deletion for",e),await T({type:"DELETE_LISTING",payload:{platform:"mercari",platformListingId:e,reason:"test_deletion"},requestId:"test-"+Date.now(),timestamp:Date.now()})},g.info("Background service worker initialized")})();