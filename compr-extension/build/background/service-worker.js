(()=>{"use strict";var e,t,r,i,o={},a={};function n(e){var t=a[e];if(void 0!==t)return t.exports;var r=a[e]={exports:{}};return o[e](r,r.exports,n),r.exports}n.m=o,t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,n.t=function(r,i){if(1&i&&(r=this(r)),8&i)return r;if("object"==typeof r&&r){if(4&i&&r.__esModule)return r;if(16&i&&"function"==typeof r.then)return r}var o=Object.create(null);n.r(o);var a={};e=e||[null,t({}),t([]),t(t)];for(var s=2&i&&r;("object"==typeof s||"function"==typeof s)&&!~e.indexOf(s);s=t(s))Object.getOwnPropertyNames(s).forEach(e=>a[e]=()=>r[e]);return a.default=()=>r,n.d(o,a),o},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce((t,r)=>(n.f[r](e,t),t),[])),n.u=e=>e+".js",n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r={},i="compr-extension:",n.l=(e,t,o,a)=>{if(r[e])r[e].push(t);else{var s,c;if(void 0!==o)for(var l=document.getElementsByTagName("script"),d=0;d<l.length;d++){var h=l[d];if(h.getAttribute("src")==e||h.getAttribute("data-webpack")==i+o){s=h;break}}s||(c=!0,(s=document.createElement("script")).charset="utf-8",n.nc&&s.setAttribute("nonce",n.nc),s.setAttribute("data-webpack",i+o),s.src=e),r[e]=[t];var u=(t,i)=>{s.onerror=s.onload=null,clearTimeout(p);var o=r[e];if(delete r[e],s.parentNode&&s.parentNode.removeChild(s),o&&o.forEach(e=>e(i)),t)return t(i)},p=setTimeout(u.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=u.bind(null,s.onerror),s.onload=u.bind(null,s.onload),c&&document.head.appendChild(s)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var i=r.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=r[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e+"../"})(),(()=>{var e={458:0};n.f.j=(t,r)=>{var i=n.o(e,t)?e[t]:void 0;if(0!==i)if(i)r.push(i[2]);else{var o=new Promise((r,o)=>i=e[t]=[r,o]);r.push(i[2]=o);var a=n.p+n.u(t),s=new Error;n.l(a,r=>{if(n.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var o=r&&("load"===r.type?"missing":r.type),a=r&&r.target&&r.target.src;s.message="Loading chunk "+t+" failed.\n("+o+": "+a+")",s.name="ChunkLoadError",s.type=o,s.request=a,i[1](s)}},"chunk-"+t,t)}};var t=(t,r)=>{var i,o,[a,s,c]=r,l=0;if(a.some(t=>0!==e[t])){for(i in s)n.o(s,i)&&(n.m[i]=s[i]);c&&c(n)}for(t&&t(r);l<a.length;l++)o=a[l],n.o(e,o)&&e[o]&&e[o][0](),e[o]=0},r=self.webpackChunkcompr_extension=self.webpackChunkcompr_extension||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})(),n.d({},{B:()=>T});const s={poshmark:{base:"https://poshmark.com",login:"https://poshmark.com/login",createListing:"https://poshmark.com/create-listing",mySales:"https://poshmark.com/sales"},mercari:{base:"https://www.mercari.com",login:"https://www.mercari.com/login",createListing:"https://www.mercari.com/sell"},depop:{base:"https://www.depop.com",login:"https://www.depop.com/login",createListing:"https://www.depop.com/products/create"}},c="saleDetectionAlarm",l="userId",d="authToken",h="settings",u="lastSaleCheck";function p(e,t,r){return{type:e,payload:t,requestId:r||`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now()}}async function g(e,t){return new Promise((r,i)=>{chrome.tabs.sendMessage(e,t,e=>{chrome.runtime.lastError?i(new Error(chrome.runtime.lastError.message)):r(e)})})}const m={debug:(...e)=>{},info:(...e)=>{console.info("[Compr Extension]",...e)},warn:(...e)=>{console.warn("[Compr Extension]",...e)},error:(...e)=>{console.error("[Compr Extension]",...e)}},f=new class{constructor(){this.userId=null,this.authToken=null,this.pollingInterval=null,this.isPolling=!1;const e=chrome.runtime.getManifest().version.includes("dev")||"1.0.0"===chrome.runtime.getManifest().version;this.baseUrl=e?"http://localhost:3000":"https://compr.co"}async loadSettings(){const e=await chrome.storage.local.get([l,d]);this.userId=e[l]||null,this.authToken=e[d]||null,m.debug("HTTP client settings loaded",{hasUserId:!!this.userId,hasAuthToken:!!this.authToken})}async updateAuth(e,t){this.userId=e,this.authToken=t,await chrome.storage.local.set({[l]:e,[d]:t}),await this.connect()}async connect(){if(this.userId&&this.authToken||await this.loadSettings(),this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/connect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,platformStatuses:[]})});if(!e.ok)throw new Error(`Connect failed: ${e.statusText}`);const t=await e.json();if(m.info("Connected to backend:",t),t.pendingJobs&&t.pendingJobs.length>0)for(const e of t.pendingJobs)await this.handleCreateListing(e);this.startPolling()}catch(e){m.error("Failed to connect to backend:",e)}else m.warn("Cannot connect: missing userId or authToken")}startPolling(){this.isPolling?m.debug("Already polling"):(this.isPolling=!0,m.info("Starting job polling"),this.pollingInterval=setInterval(()=>{this.poll()},5e3))}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isPolling=!1,m.info("Stopped polling")}async poll(){if(this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/poll?userId=${this.userId}&authToken=${this.authToken}`);if(!e.ok)return void m.warn("Poll failed:",e.statusText);const t=await e.json();if(t.hasNewJobs&&t.jobs){m.info(`Found ${t.jobs.length} new jobs`);for(const e of t.jobs)"DELETE"===e.operation?await this.handleDeleteListing(e):await this.handleCreateListing(e)}}catch(e){m.error("Polling error:",e)}}async handleCreateListing(e){const{jobId:t,platform:r,listingData:i}=e;m.info(`Processing job ${t}: Create listing on ${r}`),await T({type:"CREATE_LISTING",payload:{platform:r,listingData:i,userId:this.userId},requestId:t,timestamp:Date.now()})}async handleDeleteListing(e){const{jobId:t,platform:r,platformListingId:i}=e;m.info(`Processing job ${t}: Delete listing ${i} from ${r}`),await T({type:"DELETE_LISTING",payload:{platform:r,platformListingId:i,reason:"user_requested"},requestId:t,timestamp:Date.now()})}async markJobInProgress(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/job-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,jobId:e,status:"processing"})});if(!t.ok)throw new Error(`Failed to mark job in progress: ${t.statusText}`);m.info("Job marked as in_progress:",e)}catch(e){throw m.error("Failed to mark job in progress:",e),e}else m.warn("Cannot mark job in progress: missing credentials")}async sendResult(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/callback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,result:e})});if(!t.ok)throw new Error(`Callback failed: ${t.statusText}`);m.info("Result sent successfully")}catch(e){m.error("Failed to send result:",e)}else m.warn("Cannot send result: missing credentials")}get connected(){return this.isPolling&&!!this.userId&&!!this.authToken}},w=new class{constructor(){this.isRunning=!1}async initialize(){m.info("Initializing sale detection framework");const e=(await chrome.storage.local.get(h))[h]||{};if(!e.autoDelete)return void m.info("Auto-delete is disabled, skipping sale detection setup");const t=e.checkInterval||10;await chrome.alarms.create(c,{periodInMinutes:t,delayInMinutes:t}),m.info(`Sale detection alarm created (every ${t} minutes)`)}async startCheck(){if(this.isRunning)m.warn("Sale detection already running");else{this.isRunning=!0,m.info("Starting sale detection check");try{const e=await this.checkPoshmarkSales(),t=await this.checkMercariSales(),r=await this.checkDepopSales(),i=[...e,...t,...r];i.length>0?(m.info(`Found ${i.length} sold items`,i),await this.processSoldItems(i)):m.debug("No sold items found"),await chrome.storage.local.set({[u]:Date.now()})}catch(e){m.error("Error during sale detection check:",e)}finally{this.isRunning=!1}}}async checkPoshmarkSales(){return m.debug("Checking Poshmark for sales (not implemented)"),[]}async checkMercariSales(){return m.debug("Checking Mercari for sales (not implemented)"),[]}async checkDepopSales(){return m.debug("Checking Depop for sales (not implemented)"),[]}async processSoldItems(e){m.info("Processing sold items:",e);for(const t of e)await this.showSaleNotification(t)}async showSaleNotification(e){((await chrome.storage.local.get(h))[h]||{}).notifications&&await chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"Item Sold!",message:`Your item sold on ${e.platform}. Auto-delisting from other platforms...`,priority:2})}async manualCheck(){m.info("Manual sale detection check triggered"),await this.startCheck()}async stop(){await chrome.alarms.clear(c),m.info("Sale detection stopped")}};let y=null,b=null;const k="mercari_api_auth",I=new class{constructor(){this.apiUrl="https://www.mercari.com/v1/api",this.auth=null}async extractAuth(){m.info("Extracting Mercari auth tokens from _mwus cookie");try{const e=(await chrome.storage.local.get(k))[k];if(e?.bearerToken&&e?.csrfToken)return m.info("Using cached Mercari auth tokens"),this.auth=e,this.auth;const t=["https://www.mercari.com","https://www.mercari.com/","https://www.mercari.com/sell/","https://mercari.com"];let r;for(const e of t)try{if(r=await chrome.cookies.get({url:e,name:"_mwus"}),r){m.info(`Found _mwus cookie for URL: ${e}`);break}}catch(t){m.debug(`Failed to get cookie for ${e}:`,t)}if(!r?.value){const e=await chrome.cookies.getAll({url:"https://www.mercari.com"});throw m.error("Available cookies:",e.map(e=>`${e.name} (httpOnly: ${e.httpOnly}, secure: ${e.secure})`).join(", ")),new Error("_mwus cookie not found. This cookie may be HttpOnly and inaccessible to extensions. You may need to visit mercari.com first.")}m.info("Found _mwus cookie, decoding...");const i=atob(r.value),o=JSON.parse(i);m.debug("Decoded _mwus structure:",Object.keys(o));const a=o.accessToken,n=o.csrfSecret;if(!a||!n)throw m.error("Decoded _mwus data:",o),new Error("Missing accessToken or csrfSecret in _mwus cookie");return m.info("Successfully extracted tokens from _mwus cookie"),this.auth={bearerToken:a,csrfToken:n},await chrome.storage.local.set({[k]:this.auth}),this.auth}catch(e){throw m.error("Failed to extract Mercari auth:",e),e}}async clearAuth(){this.auth=null,await chrome.storage.local.remove(k),m.info("Cleared cached Mercari auth")}async uploadImages(e){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Mercari");m.info(`Uploading ${e.length} images to Mercari`);try{const t=await Promise.all(e.map(async e=>{const t=await fetch(e);return await t.blob()})),r=[];for(let e=0;e<t.length;e++){const i=t[e];m.info(`Uploading image ${e+1}/${t.length}`);const o=await this.uploadSingleImage(i,e);r.push(o)}return m.info("All images uploaded successfully:",r),r}catch(e){throw m.error("Failed to upload images:",e),e}}async uploadSingleImage(e,t){if(!this.auth)throw new Error("Not authenticated");const r=new FormData;r.append("operations",JSON.stringify({operationName:"uploadTempListingPhotos",variables:{input:{photos:[null]}},extensions:{persistedQuery:{version:1,sha256Hash:"9aa889ac01e549a01c66c7baabc968b0e4a7fa4cd0b6bd32b7599ce10ca09a10"}}})),r.append("map",JSON.stringify({1:["variables.input.photos.0"]})),r.append("1",e,"image.jpg");const i=await fetch(this.apiUrl,{method:"POST",headers:{authorization:`Bearer ${this.auth.bearerToken}`,"x-csrf-token":this.auth.csrfToken,"x-app-version":"1","x-platform":"web","x-gql-migration":"1","apollo-require-preflight":"true"},body:r});if(!i.ok){const e=await i.text();throw new Error(`Image upload failed: ${i.status} ${e}`)}const o=await i.json();if(!o.data?.uploadTempListingPhotos?.uploadIds?.[0])throw new Error("Upload response missing uploadId");return o.data.uploadTempListingPhotos.uploadIds[0]}async createListing(e,t){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Mercari");m.info("Creating Mercari listing via API:",e.title);try{const r=Math.round(100*e.price),i=Math.round(.1*r),o=Math.round(.85*r),a=this.mapConditionToMercariId(e.condition),s=16*(e.weight_lb||0)+(e.weight_oz||0);let c=3373;if(e.mercari_category){const t=parseInt(e.mercari_category);isNaN(t)||(c=t)}let l=19044;if(e.mercari_brand_id)l=parseInt(e.mercari_brand_id),m.info(`Using provided Mercari brand ID: ${l}`);else if(e.brand){const t=await async function(e){if(!e)return null;const t=await async function(){return y||b||(b=(async()=>{try{const e=(await n.e(462).then(n.t.bind(n,462,19))).default;return y=e.data.master,y}catch(e){return console.error("Failed to load Mercari master data:",e),{itemCategories:[],itemBrands:[]}}})(),b)}(),r=e.toLowerCase().trim(),i=t.itemBrands.find(e=>e.name.toLowerCase()===r);if(i)return i.id;const o=t.itemBrands.find(e=>e.name.toLowerCase().includes(r)||r.includes(e.name.toLowerCase()));return o?o.id:null}(e.brand);t?(l=t,m.info(`Brand name mapping: "${e.brand}" -> ${l}`)):m.warn(`Brand "${e.brand}" not found in Mercari master data, using default: ${l}`)}else m.info(`No brand provided, using default: ${l}`);const d=function(e){return e<=4?[2128]:e<=8?[2129]:e<=12?[2130]:e<=16?[2131]:e<=32?[2132]:e<=48?[2133]:e<=80?[2134]:e<=160?[2135]:[2136]}(s);m.info(`Shipping class for ${s}oz: ${d}`);const h={extensions:{persistedQuery:{version:1,sha256Hash:"265dab5d0d382d3c83dda7d65e9ad111f47c27aa5d92c7d9a4bacd890d5e32c0"}},operationName:"createListing",variables:{input:{photoIds:t,name:e.title,price:r,description:e.description,categoryId:c,conditionId:a,shippingPayerId:2,zipCode:"90210",salesFee:i,shippingClassIds:d,suggestedShippingClassIds:d,shippingWeightUnit:"OUNCE",shippingDimensionUnit:"INCH",shippingPackageWeight:s||16,minPriceForAutoPriceDrop:o,offerConfig:{minPriceForSmartOffer:0},isShippingSoyo:!1,shippingPackageLength:12,shippingPackageHeight:10,shippingPackageWidth:12,brandId:l}}};m.debug("Creating listing with payload:",JSON.stringify(h.variables.input,null,2));const u=await fetch(this.apiUrl,{method:"POST",headers:{authorization:`Bearer ${this.auth.bearerToken}`,"x-csrf-token":this.auth.csrfToken,"x-app-version":"1","x-platform":"web","x-gql-migration":"1","apollo-require-preflight":"true","content-type":"application/json"},body:JSON.stringify(h)});if(!u.ok){const e=await u.text();throw m.error("Mercari API error response:",e),401!==u.status&&403!==u.status||await this.clearAuth(),new Error(`Listing creation failed: ${u.status} ${e}`)}const p=await u.json();if(m.info("Mercari listing creation response:",p),p.errors&&p.errors.length>0){m.error("GraphQL errors:",p.errors);const e=p.errors.map(e=>e.message).join(", ");throw new Error(`GraphQL errors: ${e}`)}const g=p.data?.createListing?.id;if(!g)throw m.error("Full response:",JSON.stringify(p,null,2)),new Error("Response missing listing ID");const f=`https://www.mercari.com/us/item/${g}`;return m.info("Successfully created Mercari listing:",g),{platformListingId:g,platformUrl:f}}catch(e){throw m.error("Failed to create Mercari listing:",e),e}}mapConditionToMercariId(e){return{new:1,like_new:2,good:3,fair:4,poor:5}[e.toLowerCase()]||3}async testAuth(){try{return await this.extractAuth(),!0}catch(e){return m.warn("Mercari auth test failed:",e),!1}}async deleteListing(e){if(this.auth||await this.extractAuth(),!this.auth)throw new Error("Not authenticated with Mercari");m.info("Deleting Mercari listing via API:",e);try{const t={extensions:{persistedQuery:{version:1,sha256Hash:"55bd4e7d2bc2936638e1451da3231e484993635d7603431d1a2978e3d59656f8"}},operationName:"UpdateItemStatusMutation",variables:{input:{status:"cancel",id:e}}};m.debug("Deleting listing with payload:",JSON.stringify(t.variables,null,2));const r=await fetch(this.apiUrl,{method:"POST",headers:{authorization:`Bearer ${this.auth.bearerToken}`,"x-csrf-token":this.auth.csrfToken,"x-app-version":"1","x-platform":"web","apollo-require-preflight":"true","content-type":"application/json"},body:JSON.stringify(t)});if(!r.ok){const e=await r.text();throw m.error("Mercari API error response:",e),401!==r.status&&403!==r.status||await this.clearAuth(),new Error(`Listing deletion failed: ${r.status} ${e}`)}const i=await r.json();if(m.info("Mercari listing deletion response:",i),i.errors&&i.errors.length>0){m.error("GraphQL errors:",i.errors);const e=i.errors.map(e=>e.message).join(", ");throw new Error(`GraphQL errors: ${e}`)}m.info("Successfully deleted Mercari listing:",e)}catch(e){throw m.error("Failed to delete Mercari listing:",e),e}}async debugCookies(){const e=await chrome.cookies.getAll({domain:".mercari.com"});m.info("=== ALL MERCARI COOKIES ==="),e.forEach(e=>{m.info(`Cookie: ${e.name} = ${e.value.substring(0,50)}${e.value.length>50?"...":""}`)}),m.info("=== END COOKIES ===")}};async function T(e){m.info("Handling WebSocket message:",e.type);try{switch(e.type){case"CREATE_LISTING":await async function(e,t){const{platform:r,listingData:i,userId:o}=e;m.info(`Creating listing on ${r}:`,i.title);try{await f.markJobInProgress(t)}catch(e){m.warn("Failed to mark job as in_progress:",e)}if(await v(i.id,r,"uploading_images",0),"mercari"!==r)try{const e=s[r]?.createListing;if(!e)throw new Error(`Unknown platform: ${r}`);const t=await chrome.windows.create({url:e,type:"normal",focused:!0,state:"normal"}),o=t.tabs?.[0];if(!o?.id||!t.id)throw new Error("Failed to create tab in window");m.info(`Created listing tab ${o.id} in window ${t.id}`),await S(o.id);const a=(await chrome.windows.getAll()).find(e=>e.id!==t.id&&e.focused);a?.id&&(await chrome.windows.update(a.id,{focused:!0}),m.info("Refocused previous window, listing window now in background"));const n=p("CREATE_LISTING",{listingData:i}),c=await g(o.id,n);if(!1===c.success)throw new Error(c.error||"Listing creation failed");await f.sendResult({success:!0,listingId:i.id,platform:r,platformListingId:c.platformListingId,platformUrl:c.platformUrl,operationType:"CREATE"}),setTimeout(()=>{t.id&&chrome.windows.remove(t.id)},2e3),m.info("Listing created successfully:",c)}catch(e){throw m.error("Failed to create listing:",e),await f.sendResult({success:!1,listingId:i.id,platform:r,error:e instanceof Error?e.message:"Unknown error",operationType:"CREATE"}),m.info("Window kept open for debugging. Check the platform page for validation errors."),e}else try{m.info("Using API-based creation for Mercari (no windows)");const e=await I.uploadImages(i.photo_urls);m.info("Images uploaded, got uploadIds:",e),await v(i.id,r,"filling_form",50);const t=await I.createListing(i,e);await v(i.id,r,"completed",100),await f.sendResult({success:!0,listingId:i.id,platform:r,platformListingId:t.platformListingId,platformUrl:t.platformUrl,operationType:"CREATE"}),m.info("Mercari listing created via API:",t)}catch(e){throw m.error("Failed to create Mercari listing via API:",e),await f.sendResult({success:!1,listingId:i.id,platform:r,error:e instanceof Error?e.message:"Unknown error",operationType:"CREATE"}),e}}(e.payload,e.requestId);break;case"DELETE_LISTING":await async function(e){const{platform:t,platformListingId:r,reason:i}=e;if(m.info(`Deleting listing ${r} on ${t} (reason: ${i})`),"mercari"!==t)try{let e;switch(t){case"poshmark":return void m.warn("Poshmark deletion not yet implemented");case"depop":return void m.warn("Depop deletion not yet implemented");default:throw new Error(`Unknown platform: ${t}`)}const o=await chrome.windows.create({url:e,type:"normal",focused:!1,state:"normal"}),a=o.tabs?.[0];if(!a||"number"!=typeof a?.id)throw new Error("Failed to create tab in minimized window");const n=a.id;m.info(`Opened ${t} edit page in tab ${n} in minimized window ${o.id}`),await S(n);const s=p("DELETE_LISTING",{platformListingId:r,reason:i}),c=await g(n,s);setTimeout(()=>{o.id&&chrome.windows.remove(o.id)},2e3),m.info("Listing deleted successfully:",c),await f.sendResult({success:!0,listingId:"",platform:t,platformListingId:r,platformUrl:e,operationType:"DELETE"})}catch(e){throw m.error("Failed to delete listing:",e),await f.sendResult({success:!1,listingId:"",platform:t,platformListingId:r,error:e instanceof Error?e.message:"Unknown error",operationType:"DELETE"}),e}else try{m.info("Using API-based deletion for Mercari (no windows)"),await I.deleteListing(r),await f.sendResult({success:!0,listingId:"",platform:t,platformListingId:r,platformUrl:`https://www.mercari.com/us/item/${r}`,operationType:"DELETE"}),m.info("Mercari listing deleted via API:",r)}catch(e){throw m.error("Failed to delete Mercari listing via API:",e),await f.sendResult({success:!1,listingId:"",platform:t,platformListingId:r,error:e instanceof Error?e.message:"Unknown error",operationType:"DELETE"}),e}}(e.payload);break;case"CHECK_STATUS":await async function(){await Promise.all(["poshmark","mercari","depop"].map(e=>E(e)))}();break;default:m.warn("Unhandled WebSocket message type:",e.type)}}catch(e){m.error("Error handling message:",e)}}async function E(e){return{platform:e,loggedIn:!1,lastChecked:Date.now()}}async function v(e,t,r,i,o){m.debug("Progress update:",{listingId:e,platform:t,status:r,progress:i})}function S(e){return new Promise((t,r)=>{const i=setTimeout(()=>{r(new Error("Tab load timeout"))},3e4);chrome.tabs.onUpdated.addListener(function r(o,a){o===e&&"complete"===a.status&&(clearTimeout(i),chrome.tabs.onUpdated.removeListener(r),setTimeout(t,8e3))})})}globalThis.debugMercariCookies=async()=>{await I.debugCookies()},chrome.runtime.onInstalled.addListener(async e=>{m.info("Extension installed/updated:",e.reason),"install"===e.reason&&(await chrome.storage.local.set({settings:{autoDelete:!0,checkInterval:10,notifications:!0},platformConnections:[]}),await chrome.tabs.create({url:"https://compr.co/extension-installed"})),await w.initialize()}),chrome.runtime.onStartup.addListener(async()=>{m.info("Extension started"),await f.connect(),await w.initialize()}),chrome.alarms.onAlarm.addListener(async e=>{e.name===c&&(m.info("Sale detection alarm triggered"),await w.startCheck())}),chrome.runtime.onMessage.addListener((e,t,r)=>{switch(m.debug("Received message:",e.type,e),e.type){case"WS_MESSAGE_RECEIVED":return T(e.message).then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0;case"CONNECTION_STATUS":r({connected:f.connected});break;case"CONNECT_BACKEND":return async function(e){const{userId:t,authToken:r}=e;if(!t||!r)throw new Error("Missing userId or authToken");await f.updateAuth(t,r),m.info("Backend connection updated with new credentials")}(e.payload).then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0;case"VERIFY_SESSION":return async function(e){const{platform:t}=e;m.info(`Verifying session for ${t}`);try{const e=s[t]?.base;if(!e)throw new Error(`Unknown platform: ${t}`);const r=await chrome.tabs.query({url:`${e}/*`});let i;if(r.length>0&&r[0].id)i=r[0].id,m.info(`Using existing ${t} tab`);else{const t=await chrome.tabs.create({url:e,active:!1});if(!t.id)throw new Error("Failed to create tab");i=t.id,await S(i)}const o=p("CHECK_LOGIN",{});m.info(`Sending CHECK_LOGIN message to ${t} tab ${i}`);try{const e=await g(i,o);m.info(`${t} content script response:`,e),0===r.length&&setTimeout(()=>{m.info(`Closing ${t} verification tab ${i}`),chrome.tabs.remove(i)},1e4);const a=e.loggedIn;return m.info(`${t} verification result - DOM check: ${a}`),a?(m.info(`Session verified for ${t}`),{success:!0}):(m.warn(`Not logged in to ${t}`),{success:!1,error:`Not logged in to ${t}. Please log in and try again.`})}catch(e){return m.error(`${t} content script error:`,e),0===r.length&&setTimeout(()=>{chrome.tabs.remove(i)},2e3),{success:!1,error:"Extension verification failed. Please reload the extension at chrome://extensions and try again."}}}catch(e){return m.error("Session verification error:",e),{success:!1,error:`Verification error: ${e instanceof Error?e.message:"Unknown error during verification"}. Try reloading the extension.`}}}(e.payload).then(e=>r(e)).catch(e=>r({success:!1,error:e.message})),!0;case"MANUAL_SALE_CHECK":return w.manualCheck().then(()=>r({success:!0})).catch(e=>r({success:!1,error:e.message})),!0;case"GET_PLATFORM_STATUS":return E(e.payload.platform).then(e=>r(e)).catch(e=>r({error:e.message})),!0;default:m.warn("Unknown message type:",e.type)}}),setInterval(()=>{f.connected&&m.debug("Service worker keepalive")},2e4),f.connect(),globalThis.testDeleteListing=async e=>{m.info("TEST: Triggering deletion for",e),await T({type:"DELETE_LISTING",payload:{platform:"mercari",platformListingId:e,reason:"test_deletion"},requestId:"test-"+Date.now(),timestamp:Date.now()})},m.info("Background service worker initialized")})();