(()=>{"use strict";var e={d:(t,s)=>{for(var a in s)e.o(s,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:s[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{B:()=>u});const t={poshmark:{base:"https://poshmark.com",login:"https://poshmark.com/login",createListing:"https://poshmark.com/create-listing",mySales:"https://poshmark.com/sales"},mercari:{base:"https://www.mercari.com",login:"https://www.mercari.com/login",createListing:"https://www.mercari.com/sell"},depop:{base:"https://www.depop.com",login:"https://www.depop.com/login",createListing:"https://www.depop.com/products/create"}},s="saleDetectionAlarm",a="userId",n="authToken",o="settings",r="lastSaleCheck";function i(e,t,s){return{type:e,payload:t,requestId:s||`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now()}}async function c(e,t){return new Promise((s,a)=>{chrome.tabs.sendMessage(e,t,e=>{chrome.runtime.lastError?a(new Error(chrome.runtime.lastError.message)):s(e)})})}const l={debug:(...e)=>{},info:(...e)=>{console.info("[Compr Extension]",...e)},warn:(...e)=>{console.warn("[Compr Extension]",...e)},error:(...e)=>{console.error("[Compr Extension]",...e)}},h=new class{constructor(){this.userId=null,this.authToken=null,this.pollingInterval=null,this.isPolling=!1;const e=chrome.runtime.getManifest().version.includes("dev")||"1.0.0"===chrome.runtime.getManifest().version;this.baseUrl=e?"http://localhost:3000":"https://compr.co"}async loadSettings(){const e=await chrome.storage.local.get([a,n]);this.userId=e[a]||null,this.authToken=e[n]||null,l.debug("HTTP client settings loaded",{hasUserId:!!this.userId,hasAuthToken:!!this.authToken})}async updateAuth(e,t){this.userId=e,this.authToken=t,await chrome.storage.local.set({[a]:e,[n]:t}),await this.connect()}async connect(){if(this.userId&&this.authToken||await this.loadSettings(),this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/connect`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,platformStatuses:[]})});if(!e.ok)throw new Error(`Connect failed: ${e.statusText}`);const t=await e.json();if(l.info("Connected to backend:",t),t.pendingJobs&&t.pendingJobs.length>0)for(const e of t.pendingJobs)await this.handleCreateListing(e);this.startPolling()}catch(e){l.error("Failed to connect to backend:",e)}else l.warn("Cannot connect: missing userId or authToken")}startPolling(){this.isPolling?l.debug("Already polling"):(this.isPolling=!0,l.info("Starting job polling"),this.pollingInterval=setInterval(()=>{this.poll()},5e3))}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isPolling=!1,l.info("Stopped polling")}async poll(){if(this.userId&&this.authToken)try{const e=await fetch(`${this.baseUrl}/api/extension/poll?userId=${this.userId}&authToken=${this.authToken}`);if(!e.ok)return void l.warn("Poll failed:",e.statusText);const t=await e.json();if(t.hasNewJobs&&t.jobs){l.info(`Found ${t.jobs.length} new jobs`);for(const e of t.jobs)await this.handleCreateListing(e)}}catch(e){l.error("Polling error:",e)}}async handleCreateListing(e){const{jobId:t,platform:s,listingData:a}=e;l.info(`Processing job ${t}: Create listing on ${s}`),await u({type:"CREATE_LISTING",payload:{platform:s,listingData:a,userId:this.userId},requestId:t,timestamp:Date.now()})}async markJobInProgress(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/job-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,jobId:e,status:"processing"})});if(!t.ok)throw new Error(`Failed to mark job in progress: ${t.statusText}`);l.info("Job marked as in_progress:",e)}catch(e){throw l.error("Failed to mark job in progress:",e),e}else l.warn("Cannot mark job in progress: missing credentials")}async sendResult(e){if(this.userId&&this.authToken)try{const t=await fetch(`${this.baseUrl}/api/extension/callback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:this.userId,authToken:this.authToken,result:e})});if(!t.ok)throw new Error(`Callback failed: ${t.statusText}`);l.info("Result sent successfully")}catch(e){l.error("Failed to send result:",e)}else l.warn("Cannot send result: missing credentials")}get connected(){return this.isPolling&&!!this.userId&&!!this.authToken}},d=new class{constructor(){this.isRunning=!1}async initialize(){l.info("Initializing sale detection framework");const e=(await chrome.storage.local.get(o))[o]||{};if(!e.autoDelete)return void l.info("Auto-delete is disabled, skipping sale detection setup");const t=e.checkInterval||10;await chrome.alarms.create(s,{periodInMinutes:t,delayInMinutes:t}),l.info(`Sale detection alarm created (every ${t} minutes)`)}async startCheck(){if(this.isRunning)l.warn("Sale detection already running");else{this.isRunning=!0,l.info("Starting sale detection check");try{const e=await this.checkPoshmarkSales(),t=await this.checkMercariSales(),s=await this.checkDepopSales(),a=[...e,...t,...s];a.length>0?(l.info(`Found ${a.length} sold items`,a),await this.processSoldItems(a)):l.debug("No sold items found"),await chrome.storage.local.set({[r]:Date.now()})}catch(e){l.error("Error during sale detection check:",e)}finally{this.isRunning=!1}}}async checkPoshmarkSales(){return l.debug("Checking Poshmark for sales (not implemented)"),[]}async checkMercariSales(){return l.debug("Checking Mercari for sales (not implemented)"),[]}async checkDepopSales(){return l.debug("Checking Depop for sales (not implemented)"),[]}async processSoldItems(e){l.info("Processing sold items:",e);for(const t of e)await this.showSaleNotification(t)}async showSaleNotification(e){((await chrome.storage.local.get(o))[o]||{}).notifications&&await chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:"Item Sold!",message:`Your item sold on ${e.platform}. Auto-delisting from other platforms...`,priority:2})}async manualCheck(){l.info("Manual sale detection check triggered"),await this.startCheck()}async stop(){await chrome.alarms.clear(s),l.info("Sale detection stopped")}};async function u(e){l.info("Handling WebSocket message:",e.type);try{switch(e.type){case"CREATE_LISTING":await async function(e,s){const{platform:a,listingData:n,userId:o}=e;l.info(`Creating listing on ${a}:`,n.title);try{await h.markJobInProgress(s)}catch(e){l.warn("Failed to mark job as in_progress:",e)}await async function(e,t){l.debug("Progress update:",{listingId:e,platform:t,status:"uploading_images",progress:0})}(n.id,a);try{const e=t[a]?.createListing;if(!e)throw new Error(`Unknown platform: ${a}`);const s=await chrome.tabs.create({url:e,active:!1});if(!s.id)throw new Error("Failed to create tab");await p(s.id);const o=i("CREATE_LISTING",{listingData:n}),r=await c(s.id,o);await h.sendResult({success:!0,listingId:n.id,platform:a,platformListingId:r.platformListingId,platformUrl:r.platformUrl}),setTimeout(()=>{s.id&&chrome.tabs.remove(s.id)},2e3),l.info("Listing created successfully:",r)}catch(e){throw l.error("Failed to create listing:",e),await h.sendResult({success:!1,listingId:n.id,platform:a,error:e instanceof Error?e.message:"Unknown error"}),e}}(e.payload,e.requestId);break;case"DELETE_LISTING":await async function(e){const{platform:t,platformListingId:s,reason:a}=e;l.info(`Deleting listing ${s} on ${t} (reason: ${a})`),l.warn("Delete listing not yet implemented")}(e.payload);break;case"CHECK_STATUS":await async function(){await Promise.all(["poshmark","mercari","depop"].map(e=>m(e)))}();break;default:l.warn("Unhandled WebSocket message type:",e.type)}}catch(e){l.error("Error handling message:",e)}}async function m(e){return{platform:e,loggedIn:!1,lastChecked:Date.now()}}function p(e){return new Promise((t,s)=>{const a=setTimeout(()=>{s(new Error("Tab load timeout"))},3e4);chrome.tabs.onUpdated.addListener(function s(n,o){n===e&&"complete"===o.status&&(clearTimeout(a),chrome.tabs.onUpdated.removeListener(s),setTimeout(t,2e3))})})}chrome.runtime.onInstalled.addListener(async e=>{l.info("Extension installed/updated:",e.reason),"install"===e.reason&&(await chrome.storage.local.set({settings:{autoDelete:!0,checkInterval:10,notifications:!0},platformConnections:[]}),await chrome.tabs.create({url:"https://compr.co/extension-installed"})),await d.initialize()}),chrome.runtime.onStartup.addListener(async()=>{l.info("Extension started"),await h.connect(),await d.initialize()}),chrome.alarms.onAlarm.addListener(async e=>{e.name===s&&(l.info("Sale detection alarm triggered"),await d.startCheck())}),chrome.runtime.onMessage.addListener((e,t,s)=>{switch(l.debug("Received message:",e.type,e),e.type){case"WS_MESSAGE_RECEIVED":return u(e.message).then(()=>s({success:!0})).catch(e=>s({success:!1,error:e.message})),!0;case"CONNECTION_STATUS":s({connected:h.connected});break;case"CONNECT_BACKEND":return async function(e){const{userId:t,authToken:s}=e;if(!t||!s)throw new Error("Missing userId or authToken");await h.updateAuth(t,s),l.info("Backend connection updated with new credentials")}(e.payload).then(()=>s({success:!0})).catch(e=>s({success:!1,error:e.message})),!0;case"VALIDATE_CREDENTIALS":return async function(e){const{platform:t,username:s,password:a}=e;l.info(`Validating credentials for ${t}:`,s);try{const e={poshmark:"https://poshmark.com/login",mercari:"https://www.mercari.com/login/",depop:"https://www.depop.com/login/"}[t];if(!e)throw new Error(`Unknown platform: ${t}`);const n=await chrome.tabs.create({url:e,active:!1});if(!n.id)throw new Error("Failed to create tab");const o=n.id;await p(o);const r=i("ATTEMPT_LOGIN",{username:s,password:a});try{const e=await c(o,r);return setTimeout(()=>{chrome.tabs.remove(o)},1e3),e.success?(l.info(`Credential validation successful for ${t}`),{success:!0}):(l.warn(`Credential validation failed for ${t}:`,e.error),{success:!1,error:e.error||"Invalid credentials"})}catch(e){throw chrome.tabs.remove(o),e}}catch(e){return l.error("Credential validation error:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error during validation"}}}(e.payload).then(e=>s(e)).catch(e=>s({success:!1,error:e.message})),!0;case"MANUAL_SALE_CHECK":return d.manualCheck().then(()=>s({success:!0})).catch(e=>s({success:!1,error:e.message})),!0;case"GET_PLATFORM_STATUS":return m(e.payload.platform).then(e=>s(e)).catch(e=>s({error:e.message})),!0;default:l.warn("Unknown message type:",e.type)}}),setInterval(()=>{h.connected&&l.debug("Service worker keepalive")},2e4),h.connect(),l.info("Background service worker initialized")})();